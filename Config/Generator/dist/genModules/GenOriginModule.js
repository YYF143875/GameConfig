"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenOriginModule=void 0;const b=e(require("cli-color")),o=e(require("path")),l=e(require("node-xlsx")),L=require("../SpecialType"),E=require("../SheetType"),s=require("../utils/IOUtils"),F=require("../utils/StringUtils"),A=require("../DataModel"),J=require("../utils/CommonUtils"),f=require("../utils/LineBreak");class t{constructor(){this._sheetFileExts=[".xls",".xlsx"]}static get Instance(){return null==this._instance&&(this._instance=new t),this._instance}gen(){this._fileList=[],s.IOUtils.findFile(A.DataModel.Instance.config.excel_url,this._sheetFileExts,this._fileList),this._fileList=this._fileList.filter(e=>-1==e.indexOf("~$")),this._finalJsonDict={},this._remark={},this._enumSheets=[],this._hSheets=[],this._vSheets=[],console.log(`
================================= 开始生成源数据 =================================
`);let e=this.collectAndPreproccessSheet();return e=(e=(e=(e=(e=e&&this.proccessEnumSheet())&&this.proccessHSheet())&&this.proccessVSheet())&&this.exportData())&&this.verifyData()}convertGenerateToArray(e){let t;if(e)if(isNaN(e)){var i=e.split("|");for(let e=0;e<i.length;e++){var n=+i[e];isNaN(n)||(null==t?t=[n]:t.push(n))}}else t=[+e];return t}canUseOldData(t){var i;let n=!1;if(A.DataModel.Instance.remark&&A.DataModel.Instance.originConfig&&A.DataModel.Instance.enum)for(var a in A.DataModel.Instance.remark){a=A.DataModel.Instance.remark[a];if((a.filePath||(null==(i=null==a?void 0:a.config_other_info)?void 0:i.filePath))==t){let e;a.filePath?(e=a.fileMD5,t=a.filePath):a.config_other_info&&(e=a.config_other_info.fileMD5,t=null==(i=null==a?void 0:a.config_other_info)?void 0:i.filePath);a=s.IOUtils.getFileMD5(t);a&&a==e&&(n=!0)}}return n}getUniqueKey(i,n){let a="";return i.forEach((e,t)=>{e=n[e];null!=e&&(a+=e,t<i.length-1&&(a+="_"))}),a}collectAndPreproccessSheet(){var t;for(let e=0;e<this._fileList.length;e++){let u=this._fileList[e];var d=s.IOUtils.getFileMD5(u);if(!this.canUseOldData(u)){console.log(`正在解析 ${u} `+b.default.green(`<${d}>`));var i=l.default.parse(u);if(i&&i.length)for(let e=0;e<i.length;e++){let c=i[e].data,g=c&&c[0];if(g){let t=0;for(let e=0;e<g.length&&null==g[e];e++)t++;g=g&&g.filter(e=>null!=e);for(let e=0;e<t;e++)g.unshift(null)}var p=g&&g[0];let _=g&&g[1];if(p&&_){_=F.StringUtils.convertToUpperCamelCase(_);let h=F.StringUtils.convertToUpperCamelCase(p);switch(_){case E.SheetType.Horizontal:{let e=g&&g[2],a=(e=e&&F.StringUtils.convertToUpperCamelCase(e)+A.DataModel.Instance.config.export_suffix,h+=A.DataModel.Instance.config.export_suffix,c[1]),l={};var m=c[2];let n=c[3];var y,D=c[4],v=c[5],k=c[6];let i=[],r=[];for(let e=a.length-1;0<=e;e--){if(a[e]&&-1==a[e].indexOf("#"))return console.log(b.default.red(`${h}的${a[e]}字段没有声明类型！文件路径：`+u)),!1;!a[e]||"#"==a[e][0]||(y=a[e]&&a[e].split("#"))&&1<y.length&&(a[e]=y[0],l[a[e]]=y[1])}let t=c.slice(7,c.length);t=t.filter(e=>e.filter(e=>null!=e).length);for(let e=0;e<a.length;e++){var S=a[e];if(a.indexOf(S)!=e&&0<=a.indexOf(S))return console.log(b.default.red(p+`检测到重复的键! 键：${S}，文件路径：`+u)),!1}for(let i=0;i<n.length;i++){let t=n[i];if(isNaN(+t))n[i]=t=null;else{if(J.CommonUtils.numIsFloat(t))return console.log(b.default.red(`${p}主键不支持浮点数! 主键：${t}，文件路径：`+u)),!1;for(let e=0;e<n.length;e++)if(i!=e&&t==n[e])return console.log(b.default.red(`${p}检测到重复的主键! 主键：${t}，文件路径：`+u)),!1}}var x,M=n.filter(e=>!isNaN(e)),U=Math.min.apply(null,M),I=Math.max.apply(null,M);for(let t=U;t<=I;t++){var O=n.findIndex(e=>e==t);0<=O&&(i.push(O),r.push(a[O]))}if(0==i.length)return console.log(b.default.red(p+"没有主键! 文件路径："+u)),!1;let o={},s=[],f={};for(let n=0;n<m.length;n++){const K=m[n];if(null!=K){var N=K.split("#");let e=N[0],i=N[1];var T=a[n];let t=l[T];switch(e=e&&F.StringUtils.convertToLowerCamelCase(e)){case L.SpecialType.Array:if(!o[i]){let t=[];for(let e=0;e<m.length;e++){var $=m[e];if($==K&&(t.push(e),s.indexOf(e)<0))for(s.push(e);a.length<e+1;)a.push(null)}t.length&&(o[i]={cols:t})}break;case L.SpecialType.Link:var P="[]"===t.substring(t.length-2,t.length),C=i.replace("[]","").trim();f[T]={linkSheetName:C,linkSheetNameUppercase:F.StringUtils.convertToUpperCamelCase(C)+A.DataModel.Instance.config.export_suffix,isArray:P}}}}for(x in o){let e=o[x].cols,i=[];e.forEach(e=>{let t=a[e];t&&"#"==t[0]?(e=t.split("#"),i.push(e[1])):i.push(null)}),0<i.length&&!i.find(e=>null==e)&&(l[x]=i)}this._hSheets.push({filePath:u,fileMD5:d,sheetType:_,sheetSourceData:c,sheetName:p,sheetNameUppercase:h,parent:e,mainKeySubs:i,mainKeyNames:r,keyNames:a,fixedKeyTypes:l,formats:m,gens:D,defaults:v,annotations:k,sheetContent:t,arrayColAll:s,arrayColDict:o,linkDict:f});break}case E.SheetType.Vertical:{h+=A.DataModel.Instance.config.export_suffix;let l={},r={},o={},s={},e=c.slice(2,c.length);(e=e.filter(e=>e.filter(e=>null!=e).length)).forEach(e=>{if(-1==e[0].indexOf("#"))return console.log(b.default.red(`${h}的${e[0]}字段没有声明类型！文件路径：`+u)),!1;var t=e[0].split("#"),i=t[0],t=1<t.length?t[1]:null,n=this.convertGenerateToArray(e[1]),a=e[2],e=e[3];l[i]=a,t&&(r[i]=t),n&&(o[i]=n),e&&(s[i]=e)}),this._vSheets.push({filePath:u,fileMD5:d,sheetType:_,sheetSourceData:c,sheetName:p,sheetNameUppercase:h,fixedKeyDatas:l,fixedKeyTypes:r,gens:o,annotations:s,sheetContent:e});break}case E.SheetType.Enum:{M=g[2];let e=c.slice(2,c.length);e=e.filter(e=>e.filter(e=>null!=e).length),this._enumSheets.push({filePath:u,fileMD5:d,sheetSourceData:c,sheetName:p,sheetNameUppercase:h,sheetType:_,gens:M,sheetContent:e});break}default:console.log(b.default.red(`不支持的表格配置类型！文件路径：${u}，表名：${p}，表类型：`+_))}}}}else for(var n in A.DataModel.Instance.remark){var a=A.DataModel.Instance.remark[n];if((a.filePath||(null==(t=null==a?void 0:a.config_other_info)?void 0:t.filePath))==u){let e;switch(e=(a.config_other_info||a).sheetType){case E.SheetType.Horizontal:this._hSheets.push({filePath:u,fileMD5:d,sheetType:e,sheetNameUppercase:n,parent:a.config_other_info.parent,isSingleMainKey:a.config_other_info.isSingleMainKey,mainKeySubs:a.config_other_info.mainKeySubs,mainKeyNames:a.config_other_info.mainKeyNames,mainKeyOnlyOneAndIsEnum:a.config_other_info.mainKeyOnlyOneAndIsEnum,isUseOldData:!0,oldData:A.DataModel.Instance.originConfig[n],oldRemarkData:a});break;case E.SheetType.Vertical:this._vSheets.push({filePath:u,fileMD5:d,sheetType:e,sheetNameUppercase:n,isUseOldData:!0,oldData:A.DataModel.Instance.originConfig[n],oldRemarkData:a});break;case E.SheetType.Enum:this._enumSheets.push({filePath:u,fileMD5:d,sheetNameUppercase:n,sheetType:e,gens:a.generate,isUseOldData:!0,oldData:A.DataModel.Instance.enum[n]})}}}}return!0}proccessEnumSheet(){for(let t=0;t<this._enumSheets.length;t++){let e=this._enumSheets[t];var i=e.filePath,n=e.fileMD5;if(e.isUseOldData)e.enumData=e.oldData;else{var a=e.sheetContent;let t=[];for(let e=0;e<a.length;e++){var l=a[e];t.push({key:l[0],value:l[1],annotation:l[2]})}e.enumData=t}this._remark[e.sheetNameUppercase]={filePath:i,fileMD5:n,generate:Array.isArray(e.gens)?e.gens:this.convertGenerateToArray(e.gens),sheetType:e.sheetType}}return!0}proccessHSheet(){for(let e=0;e<this._hSheets.length;e++){let i=this._hSheets[e];var r=i.filePath,p=i.fileMD5;let d=i.sheetNameUppercase;var m=i.parent,y=i.mainKeySubs,D=i.mainKeyNames;if(i.isUseOldData){let e={},n=i.oldData;for(var t in n.data){let i={};n.data[t].forEach((e,t)=>{i[n.fixed_keys[t]]=e}),e[t]=i}if(i.dict=e,i.optimizedDict=n,this._finalJsonDict[d])return k=null!=(k=this._remark[d])&&k.config_other_info?k.config_other_info.filePath:null==k?void 0:k.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${r}，表名：${d}，另一个文件路径：`+k)),!1;this._finalJsonDict[d]=n,this._remark[d]=i.oldRemarkData}else{let s=i.keyNames,o=i.fixedKeyTypes,f=i.formats,h=i.gens,c=i.defaults,g=i.annotations;var v,k,S=i.sheetContent;let e=i.arrayColAll,_=i.arrayColDict,u=i.linkDict,a={},n={},l=[];for(let n=0;n<S.length;n++){var x=S[n],M=this.getUniqueKey(y,x);if(M){let i={};for(let t=0;t<s.length;t++){var U=s[t];if(0<=e.indexOf(t)){var I=f[t].split("#")[1];if(!i[I]){-1==l.indexOf(I)&&l.push(I);let o=[];for(let e=n;e<S.length;e++){let r=S[e];if(this.getUniqueKey(y,r)&&e!=n)break;{let e=_[I].cols,i=!e.find(e=>!s[e]),n=1<e.length,a=n?i?{}:[]:null,l=!1;if(e.forEach(e=>{let t=r[e];null==t?t=c[e]:l=!0,null!=t&&(n?i?a[s[e]]=t:a.push(t):o.push(t))}),!l)break;n&&(i&&Object.keys(a).length||!i&&a.length)&&o.push(a)}}i[I]=o.length?o:""}}else if(null!=U){-1==l.indexOf(U)&&l.push(U);let e=x[t];e=null==e?null==c[t]?"":c[t]:e;try{var O=JSON.parse(e);e=O}catch(e){}i[U]=e}}a[M]=i}}for(v in n={data:{},fixed_keys:l},a){let t=a[v],i=[];l.forEach(e=>{i.push(t[e])}),n.data[v]=i}if(i.dict=a,i.optimizedDict=n,this._finalJsonDict[d])return N=null!=(k=this._remark[d])&&k.config_other_info?k.config_other_info.filePath:null==k?void 0:k.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${r}，表名：${d}，另一个文件路径：`+N)),!1;this._finalJsonDict[d]=n,this._remark[d]||(this._remark[d]={}),n.fixed_keys&&n.fixed_keys.forEach(t=>{var e,i="",n=s.findIndex(e=>e==t);let a;if(_[t]){let e=_[t].cols;e.forEach(e=>{i?i+=", "+g[e]:i="["+g[e]}),i&&(i+="]"),a=e[0]}else a=n,i=g[n];e=this.convertGenerateToArray(h[a]);let l,r=f[n];n=r&&r.split("#"),n&&2==n.length&&n[0]==L.SpecialType.Enum&&(l=F.StringUtils.convertToUpperCamelCase(n[1])),n=u[t];this._remark[d][t]={fixedType:o[t],generate:e,annotation:i,enum:l,link:n&&n.linkSheetNameUppercase,linkIsArray:n&&n.isArray}});let t;if(1==y.length){let e=f[y[0]];var N=e&&e.split("#");N&&2==N.length&&N[0]==L.SpecialType.Enum&&(t=F.StringUtils.convertToUpperCamelCase(N[1]))}this._remark[d].config_other_info={filePath:r,fileMD5:p,sheetType:i.sheetType,isSingleMainKey:1==y.length,parent:m,mainKeySubs:y,mainKeyNames:D,mainKeyOnlyOneAndIsEnum:1==D.length&&t}}}return!0}proccessVSheet(){for(let t=0;t<this._vSheets.length;t++){let e=this._vSheets[t];var i=e.filePath,n=e.fileMD5,a=e.sheetNameUppercase;if(e.isUseOldData){var l=e.oldData,r=e.oldData;if(e.dict=l,e.optimizedDict=r,this._finalJsonDict[a])return l=null!=(l=this._remark[a])&&l.config_other_info?l.config_other_info.filePath:null==l?void 0:l.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${i}，表名：${a}，另一个文件路径：`+l)),!1;this._finalJsonDict[a]=r,this._remark[a]||(this._remark[a]={}),this._remark[a]=e.oldRemarkData}else{var o=e.fixedKeyDatas,s=e.fixedKeyTypes,f=e.gens,h=e.annotations;let t={};var c,g,_;for(c in o){let e=o[c]||"";try{e=e.replace(/\t/g,"").replace(/\r/g,"").replace(/\n/g,"");var u=JSON.parse(e);e=u}catch(e){}var d=e;t[c]=d}if(l=t,e.dict=t,e.optimizedDict=l,this._finalJsonDict[a])return g=null!=(r=this._remark[a])&&r.config_other_info?r.config_other_info.filePath:null==r?void 0:r.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${i}，表名：${a}，另一个文件路径：`+g)),!1;for(_ in this._finalJsonDict[a]=l,this._remark[a]||(this._remark[a]={}),t){var p=f[_],m=h[_];this._remark[a][_]={fixedType:s[_],generate:p,annotation:m}}this._remark[a].config_other_info={filePath:i,fileMD5:n,sheetType:E.SheetType.Vertical}}}return!0}exportData(){s.IOUtils.deleteFolderFile(A.DataModel.Instance.config.origin_export_url,!1),s.IOUtils.makeDir(A.DataModel.Instance.config.origin_export_url);let t={};for(let e=0;e<this._enumSheets.length;e++){var i=this._enumSheets[e];t[i.sheetNameUppercase]=i.enumData}var e=JSON.stringify(t,null,4);s.IOUtils.writeTextFile(A.DataModel.Instance.enumURL,e,f.LineBreak.CRLF,null,"导出源配置失败！ -> {0}, {1}");for(let e=0;e<this._hSheets.length;e++){var n=this._hSheets[e],a=JSON.stringify(n.dict,null,4);s.IOUtils.writeTextFile(o.default.join(A.DataModel.Instance.config.origin_export_url,n.sheetNameUppercase+".json"),a,f.LineBreak.CRLF,null,"导出源配置失败！ -> {0}, {1}")}for(let e=0;e<this._vSheets.length;e++){var l=this._vSheets[e],r=JSON.stringify(l.dict,null,4);s.IOUtils.writeTextFile(o.default.join(A.DataModel.Instance.config.origin_export_url,l.sheetNameUppercase+".json"),r,f.LineBreak.CRLF,null,"导出源配置失败！ -> {0}, {1}")}e=JSON.stringify(this._finalJsonDict);return s.IOUtils.writeTextFile(A.DataModel.Instance.originConfigURL,e,f.LineBreak.CRLF,"导出源配置成功！","导出源配置失败！ -> {0}, {1}"),s.IOUtils.writeTextFile(A.DataModel.Instance.remarkURL,JSON.stringify(this._remark,null,4),f.LineBreak.CRLF,null,"导出Remark文件失败！ -> {0}, {1}"),!0}verifyData(){let o=!1,i=(A.DataModel.Instance.reset(),Object.keys(A.DataModel.Instance.originConfig));for(let r=i.length-1;0<=r;r--){let l=i[r];var n=A.DataModel.Instance.remark[l];if(n.config_other_info){let t=i.filter((e,t)=>{var i;if(t!=r){var n=A.DataModel.Instance.remark[e];if(n.config_other_info){var a=Object.keys(n);for(let e=a.length-1;0<=e;e--)if((null==(i=n[a[e]])?void 0:i.link)==l)return!0}}return!1});if(t.length){var a=n.config_other_info.filePath,s=Object.keys(n);for(let e=s.length-1;0<=e;e--){var f=s[e],f=t.indexOf(null==(f=n[f])?void 0:f.link),h=t[f];-1!=f&&(o=!0,f=A.DataModel.Instance.remark[h].config_other_info.filePath,console.log(b.default.red(l+` 和 ${h} 循环链接（Link）了，请检查！文件路径：${a}，`+f)))}}}}if(o)return!1;for(let e=i.length-1;0<=e;e--){var l=i[e],r=A.DataModel.Instance.remark[l];if(r.config_other_info){let a=[],e=l,t=r;for(;t.config_other_info.parent;){var c=a.indexOf(t.config_other_info.parent),g=A.DataModel.Instance.remark[t.config_other_info.parent];if(!g){o=!0,console.log(b.default.red(`父类不存在！${t.config_other_info.parent}，文件路径：`+t.config_other_info.filePath));break}if(!g.config_other_info){o=!0,console.log(b.default.red(`不允许非水平表被继承！${e}，${t.config_other_info.parent}，文件路径：${t.config_other_info.filePath}，`+g.filePath));break}if(-1!=c){o=!0,a.push(t.config_other_info.parent),t.config_other_info.parent;let i="",n="";a.forEach((e,t)=>{i+=e;e=A.DataModel.Instance.remark[e];n+=e.config_other_info.filePath,t!=a.length-1&&(i+="，",n+="，")}),console.log(b.default.red(`循环继承，这是不被允许的！${i}，文件路径：`+n));break}e=t.config_other_info.parent,t=g,a.push(e)}}}for(let e=i.length-1;0<=e;e--){var _=i[e],u=A.DataModel.Instance.originConfig[_];let n=A.DataModel.Instance.remark[_];var d=A.DataModel.Instance.getParents(_);if(d)for(let e=0;e<d.length;e++){var p=d[e];let t=A.DataModel.Instance.originConfig[p];var m,y=A.DataModel.Instance.remark[p],D=y.config_other_info.filePath;let i=!1;if(n.config_other_info.mainKeyNames.length==y.config_other_info.mainKeyNames.length){for(let e=0;e<n.config_other_info.mainKeyNames.length;e++)if(n.config_other_info.mainKeyNames[e]!=y.config_other_info.mainKeyNames[e]){i=!0;break}}else i=!0;i&&(o=!0,console.log(b.default.red(`${_}继承自${n.config_other_info.parent}，然而他们的主键并不一致，这是不被允许的！父表主键：${y.config_other_info.mainKeyNames}，子表主键：${n.config_other_info.mainKeyNames}，父表文件路径：${D}，子表文件路径：`+n.config_other_info.filePath)));for(let e=0;e<u.fixed_keys.length;e++){var v=u.fixed_keys[e];-1==n.config_other_info.mainKeyNames.indexOf(v)&&-1!=t.fixed_keys.indexOf(v)&&(o=!0,console.log(b.default.red(`${_}继承自${n.config_other_info.parent}，${v}字段重复了，这是不被允许的！父表文件路径：${D}，子表文件路径：`+n.config_other_info.filePath)))}for(m in u.data)t.data[m]||(o=!0,console.log(b.default.red(`${_}继承自${n.config_other_info.parent}，${_} 中的 ${m} 在 ${n.config_other_info.parent} 中无法找到，这是不被允许的！父表文件路径：${D}，子表文件路径：`+n.config_other_info.filePath)))}}return!o}}exports.GenOriginModule=t;