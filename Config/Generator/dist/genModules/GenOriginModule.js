"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenOriginModule=void 0;const b=e(require("cli-color")),o=e(require("path")),l=e(require("node-xlsx")),E=require("../SpecialType"),L=require("../SheetType"),F=require("../utils/IOUtils"),A=require("../utils/StringUtils"),J=require("../DataModel"),j=require("../utils/CommonUtils"),T=require("../utils/LineBreak");class t{constructor(){this._sheetFileExts=[".xls",".xlsx"]}static get Instance(){return null==this._instance&&(this._instance=new t),this._instance}gen(){this._fileList=[],F.IOUtils.findFile(J.DataModel.Instance.config.excel_url,this._sheetFileExts,this._fileList),this._fileList=this._fileList.filter(e=>-1==e.indexOf("~$")),this._finalJsonDict={},this._remark={},this._enumSheets=[],this._hSheets=[],this._vSheets=[],console.log(`
================================= 开始生成源数据 =================================
`);let e=this.collectAndPreproccessSheet();return e=(e=(e=(e=(e=(e=e&&this.proccessEnumSheet())&&this.proccessHSheet())&&this.proccessVSheet())&&this.exportData())&&this.checkAndExportExtendsTreeData())&&this.verifyData()}convertGenerateToArray(e){let t;if(e)if(isNaN(e)){var n=e.split("|");for(let e=0;e<n.length;e++){var i=+n[e];isNaN(i)||(null==t?t=[i]:t.push(i))}}else t=[+e];return t}canUseOldData(t){var n;let i=!1;if(J.DataModel.Instance.remark&&J.DataModel.Instance.originConfig&&J.DataModel.Instance.enum)for(var a in J.DataModel.Instance.remark){a=J.DataModel.Instance.remark[a];if((a.filePath||(null==(n=null==a?void 0:a.config_other_info)?void 0:n.filePath))==t){let e;a.filePath?(e=a.fileMD5,t=a.filePath):a.config_other_info&&(e=a.config_other_info.fileMD5,t=null==(n=null==a?void 0:a.config_other_info)?void 0:n.filePath);a=F.IOUtils.getFileMD5(t);a&&a==e&&(i=!0)}}return i}getUniqueKey(n,i){let a="";return n.forEach((e,t)=>{e=i[e];null!=e&&(a+=e,t<n.length-1&&(a+="_"))}),a}collectAndPreproccessSheet(){var t;for(let e=0;e<this._fileList.length;e++){let _=this._fileList[e];var d=F.IOUtils.getFileMD5(_);if(!this.canUseOldData(_)){console.log(`正在解析 ${_} `+b.default.green(`<${d}>`));var n=l.default.parse(_);if(n&&n.length)for(let e=0;e<n.length;e++){let c=n[e].data,g=c&&c[0];if(g){let t=0;for(let e=0;e<g.length&&null==g[e];e++)t++;g=g&&g.filter(e=>null!=e);for(let e=0;e<t;e++)g.unshift(null)}var p=g&&g[0];let u=g&&g[1];if(p&&u){u=A.StringUtils.convertToUpperCamelCase(u);let h=A.StringUtils.convertToUpperCamelCase(p);switch(u){case L.SheetType.Horizontal:{let e=g&&g[2],a=(e=e&&A.StringUtils.convertToUpperCamelCase(e)+J.DataModel.Instance.config.export_suffix,h+=J.DataModel.Instance.config.export_suffix,c[1]),l={};var m=c[2];let i=c[3];var y,D=c[4],v=c[5],k=c[6];let n=[],r=[];for(let e=a.length-1;0<=e;e--){if(a[e]&&-1==a[e].indexOf("#"))return console.log(b.default.red(`${h}的${a[e]}字段没有声明类型！文件路径：`+_)),!1;!a[e]||"#"==a[e][0]||(y=a[e]&&a[e].split("#"))&&1<y.length&&(a[e]=y[0],l[a[e]]=y[1])}let t=c.slice(7,c.length);t=t.filter(e=>e.filter(e=>null!=e).length);for(let e=0;e<a.length;e++){var S=a[e];if(a.indexOf(S)!=e&&0<=a.indexOf(S))return console.log(b.default.red(p+`检测到重复的键! 键：${S}，文件路径：`+_)),!1}for(let n=0;n<i.length;n++){let t=i[n];if(isNaN(+t))i[n]=t=null;else{if(j.CommonUtils.numIsFloat(t))return console.log(b.default.red(`${p}主键不支持浮点数! 主键：${t}，文件路径：`+_)),!1;for(let e=0;e<i.length;e++)if(n!=e&&t==i[e])return console.log(b.default.red(`${p}检测到重复的主键! 主键：${t}，文件路径：`+_)),!1}}var M,x=i.filter(e=>!isNaN(e)),I=Math.min.apply(null,x),O=Math.max.apply(null,x);for(let t=I;t<=O;t++){var U=i.findIndex(e=>e==t);0<=U&&(n.push(U),r.push(a[U]))}if(0==n.length)return console.log(b.default.red(p+"没有主键! 文件路径："+_)),!1;let o={},s=[],f={};for(let i=0;i<m.length;i++){const K=m[i];if(null!=K){var T=K.split("#");let e=T[0],n=T[1];var N=a[i];let t=l[N];switch(e=e&&A.StringUtils.convertToLowerCamelCase(e)){case E.SpecialType.Array:if(!o[n]){let t=[];for(let e=0;e<m.length;e++){var $=m[e];if($==K&&(t.push(e),s.indexOf(e)<0))for(s.push(e);a.length<e+1;)a.push(null)}t.length&&(o[n]={cols:t})}break;case E.SpecialType.Link:var P="[]"===t.substring(t.length-2,t.length),C=n.replace("[]","").trim();f[N]={linkSheetName:C,linkSheetNameUppercase:A.StringUtils.convertToUpperCamelCase(C)+J.DataModel.Instance.config.export_suffix,isArray:P}}}}for(M in o){let e=o[M].cols,n=[];e.forEach(e=>{let t=a[e];t&&"#"==t[0]?(e=t.split("#"),n.push(e[1])):n.push(null)}),0<n.length&&!n.find(e=>null==e)&&(l[M]=n)}this._hSheets.push({filePath:_,fileMD5:d,sheetType:u,sheetSourceData:c,sheetName:p,sheetNameUppercase:h,parent:e,mainKeySubs:n,mainKeyNames:r,keyNames:a,fixedKeyTypes:l,formats:m,gens:D,defaults:v,annotations:k,sheetContent:t,arrayColAll:s,arrayColDict:o,linkDict:f});break}case L.SheetType.Vertical:{h+=J.DataModel.Instance.config.export_suffix;let l={},r={},o={},s={},e=c.slice(2,c.length);(e=e.filter(e=>e.filter(e=>null!=e).length)).forEach(e=>{if(-1==e[0].indexOf("#"))return console.log(b.default.red(`${h}的${e[0]}字段没有声明类型！文件路径：`+_)),!1;var t=e[0].split("#"),n=t[0],t=1<t.length?t[1]:null,i=this.convertGenerateToArray(e[1]),a=e[2],e=e[3];l[n]=a,t&&(r[n]=t),i&&(o[n]=i),e&&(s[n]=e)}),this._vSheets.push({filePath:_,fileMD5:d,sheetType:u,sheetSourceData:c,sheetName:p,sheetNameUppercase:h,fixedKeyDatas:l,fixedKeyTypes:r,gens:o,annotations:s,sheetContent:e});break}case L.SheetType.Enum:{x=g[2];let e=c.slice(2,c.length);e=e.filter(e=>e.filter(e=>null!=e).length),this._enumSheets.push({filePath:_,fileMD5:d,sheetSourceData:c,sheetName:p,sheetNameUppercase:h,sheetType:u,gens:x,sheetContent:e});break}default:console.log(b.default.red(`不支持的表格配置类型！文件路径：${_}，表名：${p}，表类型：`+u))}}}}else for(var i in J.DataModel.Instance.remark){var a=J.DataModel.Instance.remark[i];if((a.filePath||(null==(t=null==a?void 0:a.config_other_info)?void 0:t.filePath))==_){let e;switch(e=(a.config_other_info||a).sheetType){case L.SheetType.Horizontal:this._hSheets.push({filePath:_,fileMD5:d,sheetType:e,sheetNameUppercase:i,parent:a.config_other_info.parent,isSingleMainKey:a.config_other_info.isSingleMainKey,mainKeySubs:a.config_other_info.mainKeySubs,mainKeyNames:a.config_other_info.mainKeyNames,mainKeyOnlyOneAndIsEnum:a.config_other_info.mainKeyOnlyOneAndIsEnum,isUseOldData:!0,oldData:J.DataModel.Instance.originConfig[i],oldRemarkData:a});break;case L.SheetType.Vertical:this._vSheets.push({filePath:_,fileMD5:d,sheetType:e,sheetNameUppercase:i,isUseOldData:!0,oldData:J.DataModel.Instance.originConfig[i],oldRemarkData:a});break;case L.SheetType.Enum:this._enumSheets.push({filePath:_,fileMD5:d,sheetNameUppercase:i,sheetType:e,gens:a.generate,isUseOldData:!0,oldData:J.DataModel.Instance.enum[i]})}}}}return!0}proccessEnumSheet(){for(let t=0;t<this._enumSheets.length;t++){let e=this._enumSheets[t];var n=e.filePath,i=e.fileMD5;if(e.isUseOldData)e.enumData=e.oldData;else{var a=e.sheetContent;let t=[];for(let e=0;e<a.length;e++){var l=a[e];t.push({key:l[0],value:l[1],annotation:l[2]})}e.enumData=t}this._remark[e.sheetNameUppercase]={filePath:n,fileMD5:i,generate:Array.isArray(e.gens)?e.gens:this.convertGenerateToArray(e.gens),sheetType:e.sheetType}}return!0}proccessHSheet(){for(let e=0;e<this._hSheets.length;e++){let n=this._hSheets[e];var r=n.filePath,p=n.fileMD5;let d=n.sheetNameUppercase;var m=n.parent,y=n.mainKeySubs,D=n.mainKeyNames;if(n.isUseOldData){let e={},i=n.oldData;for(var t in i.data){let n={};i.data[t].forEach((e,t)=>{n[i.fixed_keys[t]]=e}),e[t]=n}if(n.dict=e,n.optimizedDict=i,this._finalJsonDict[d])return k=null!=(k=this._remark[d])&&k.config_other_info?k.config_other_info.filePath:null==k?void 0:k.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${r}，表名：${d}，另一个文件路径：`+k)),!1;this._finalJsonDict[d]=i,this._remark[d]=n.oldRemarkData}else{let s=n.keyNames,o=n.fixedKeyTypes,f=n.formats,h=n.gens,c=n.defaults,g=n.annotations;var v,k,S=n.sheetContent;let e=n.arrayColAll,u=n.arrayColDict,_=n.linkDict,a={},i={},l=[];for(let i=0;i<S.length;i++){var M=S[i],x=this.getUniqueKey(y,M);if(x){let n={};for(let t=0;t<s.length;t++){var I=s[t];if(0<=e.indexOf(t)){var O=f[t].split("#")[1];if(!n[O]){-1==l.indexOf(O)&&l.push(O);let o=[];for(let e=i;e<S.length;e++){let r=S[e];if(this.getUniqueKey(y,r)&&e!=i)break;{let e=u[O].cols,n=!e.find(e=>!s[e]),i=1<e.length,a=i?n?{}:[]:null,l=!1;if(e.forEach(e=>{let t=r[e];null==t?t=c[e]:l=!0,null!=t&&(i?n?a[s[e]]=t:a.push(t):o.push(t))}),!l)break;i&&(n&&Object.keys(a).length||!n&&a.length)&&o.push(a)}}n[O]=o.length?o:""}}else if(null!=I){-1==l.indexOf(I)&&l.push(I);let e=M[t];e=null==e?null==c[t]?"":c[t]:e;try{var U=JSON.parse(e);e=U}catch(e){}n[I]=e}}a[x]=n}}for(v in i={data:{},fixed_keys:l},a){let t=a[v],n=[];l.forEach(e=>{n.push(t[e])}),i.data[v]=n}if(n.dict=a,n.optimizedDict=i,this._finalJsonDict[d])return T=null!=(k=this._remark[d])&&k.config_other_info?k.config_other_info.filePath:null==k?void 0:k.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${r}，表名：${d}，另一个文件路径：`+T)),!1;this._finalJsonDict[d]=i,this._remark[d]||(this._remark[d]={}),i.fixed_keys&&i.fixed_keys.forEach(t=>{var e,n="",i=s.findIndex(e=>e==t);let a;if(u[t]){let e=u[t].cols;e.forEach(e=>{n?n+=", "+g[e]:n="["+g[e]}),n&&(n+="]"),a=e[0]}else a=i,n=g[i];e=this.convertGenerateToArray(h[a]);let l,r=f[i];i=r&&r.split("#"),i&&2==i.length&&i[0]==E.SpecialType.Enum&&(l=A.StringUtils.convertToUpperCamelCase(i[1])),i=_[t];this._remark[d][t]={fixedType:o[t],generate:e,annotation:n,enum:l,link:i&&i.linkSheetNameUppercase,linkIsArray:i&&i.isArray}});let t;if(1==y.length){let e=f[y[0]];var T=e&&e.split("#");T&&2==T.length&&T[0]==E.SpecialType.Enum&&(t=A.StringUtils.convertToUpperCamelCase(T[1]))}this._remark[d].config_other_info={filePath:r,fileMD5:p,sheetType:n.sheetType,isSingleMainKey:1==y.length,parent:m,mainKeySubs:y,mainKeyNames:D,mainKeyOnlyOneAndIsEnum:1==D.length&&t}}}return!0}proccessVSheet(){for(let t=0;t<this._vSheets.length;t++){let e=this._vSheets[t];var n=e.filePath,i=e.fileMD5,a=e.sheetNameUppercase;if(e.isUseOldData){var l=e.oldData,r=e.oldData;if(e.dict=l,e.optimizedDict=r,this._finalJsonDict[a])return l=null!=(l=this._remark[a])&&l.config_other_info?l.config_other_info.filePath:null==l?void 0:l.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${n}，表名：${a}，另一个文件路径：`+l)),!1;this._finalJsonDict[a]=r,this._remark[a]||(this._remark[a]={}),this._remark[a]=e.oldRemarkData}else{var o=e.fixedKeyDatas,s=e.fixedKeyTypes,f=e.gens,h=e.annotations;let t={};var c,g,u;for(c in o){let e=o[c]||"";try{e=e.replace(/\t/g,"").replace(/\r/g,"").replace(/\n/g,"");var _=JSON.parse(e);e=_}catch(e){}var d=e;t[c]=d}if(l=t,e.dict=t,e.optimizedDict=l,this._finalJsonDict[a])return g=null!=(r=this._remark[a])&&r.config_other_info?r.config_other_info.filePath:null==r?void 0:r.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${n}，表名：${a}，另一个文件路径：`+g)),!1;for(u in this._finalJsonDict[a]=l,this._remark[a]||(this._remark[a]={}),t){var p=f[u],m=h[u];this._remark[a][u]={fixedType:s[u],generate:p,annotation:m}}this._remark[a].config_other_info={filePath:n,fileMD5:i,sheetType:L.SheetType.Vertical}}}return!0}exportData(){F.IOUtils.deleteFolderFile(J.DataModel.Instance.config.origin_export_url,!1),F.IOUtils.makeDir(J.DataModel.Instance.config.origin_export_url);let t={};for(let e=0;e<this._enumSheets.length;e++){var n=this._enumSheets[e];t[n.sheetNameUppercase]=n.enumData}var e=JSON.stringify(t,null,4);F.IOUtils.writeTextFile(J.DataModel.Instance.enumURL,e,T.LineBreak.CRLF,null,"导出源配置失败！ -> {0}, {1}");for(let e=0;e<this._hSheets.length;e++){var i=this._hSheets[e],a=JSON.stringify(i.dict,null,4);F.IOUtils.writeTextFile(o.default.join(J.DataModel.Instance.config.origin_export_url,i.sheetNameUppercase+".json"),a,T.LineBreak.CRLF,null,"导出源配置失败！ -> {0}, {1}")}for(let e=0;e<this._vSheets.length;e++){var l=this._vSheets[e],r=JSON.stringify(l.dict,null,4);F.IOUtils.writeTextFile(o.default.join(J.DataModel.Instance.config.origin_export_url,l.sheetNameUppercase+".json"),r,T.LineBreak.CRLF,null,"导出源配置失败！ -> {0}, {1}")}e=JSON.stringify(this._finalJsonDict);return F.IOUtils.writeTextFile(J.DataModel.Instance.originConfigURL,e,T.LineBreak.CRLF,"导出源配置成功！","导出源配置失败！ -> {0}, {1}"),F.IOUtils.writeTextFile(J.DataModel.Instance.remarkURL,JSON.stringify(this._remark,null,4),T.LineBreak.CRLF,null,"导出Remark文件失败！ -> {0}, {1}"),!0}checkAndExportExtendsTreeData(){let l=!1,t=(J.DataModel.Instance.reset(),Object.keys(J.DataModel.Instance.originConfig));for(let e=t.length-1;0<=e;e--){var n=t[e],i=J.DataModel.Instance.remark[n];if(i.config_other_info){let a=[],e=n,t=i;for(;t.config_other_info.parent;){var r=a.indexOf(t.config_other_info.parent),o=J.DataModel.Instance.remark[t.config_other_info.parent];if(!o){l=!0,console.log(b.default.red(`父类不存在！${t.config_other_info.parent}，文件路径：`+t.config_other_info.filePath));break}if(!o.config_other_info){l=!0,console.log(b.default.red(`不允许非水平表被继承！${e}，${t.config_other_info.parent}，文件路径：${t.config_other_info.filePath}，`+o.filePath));break}if(-1!=r){l=!0,a.push(t.config_other_info.parent),t.config_other_info.parent;let n="",i="";a.forEach((e,t)=>{n+=e;e=J.DataModel.Instance.remark[e];i+=e.config_other_info.filePath,t!=a.length-1&&(n+="，",i+="，")}),console.log(b.default.red(`循环继承，这是不被允许的！${n}，文件路径：`+i));break}e=t.config_other_info.parent,t=o,a.push(e)}}}for(let e=t.length-1;0<=e;e--){var a=t[e],s=J.DataModel.Instance.originConfig[a];let i=J.DataModel.Instance.remark[a];var f=J.DataModel.Instance.getParents(a);if(f)for(let e=0;e<f.length;e++){var h=f[e];let t=J.DataModel.Instance.originConfig[h];var c,g=J.DataModel.Instance.remark[h],u=g.config_other_info.filePath;let n=!1;if(i.config_other_info.mainKeyNames.length==g.config_other_info.mainKeyNames.length){for(let e=0;e<i.config_other_info.mainKeyNames.length;e++)if(i.config_other_info.mainKeyNames[e]!=g.config_other_info.mainKeyNames[e]){n=!0;break}}else n=!0;n&&(l=!0,console.log(b.default.red(`${a}继承自${i.config_other_info.parent}，然而他们的主键并不一致，这是不被允许的！父表主键：${g.config_other_info.mainKeyNames}，子表主键：${i.config_other_info.mainKeyNames}，父表文件路径：${u}，子表文件路径：`+i.config_other_info.filePath)));for(let e=0;e<s.fixed_keys.length;e++){var _=s.fixed_keys[e];-1==i.config_other_info.mainKeyNames.indexOf(_)&&-1!=t.fixed_keys.indexOf(_)&&(l=!0,console.log(b.default.red(`${a}继承自${i.config_other_info.parent}，${_}字段重复了，这是不被允许的！父表文件路径：${u}，子表文件路径：`+i.config_other_info.filePath)))}for(c in s.data)t.data[c]||(l=!0,console.log(b.default.red(`${a}继承自${i.config_other_info.parent}，${a} 中的 ${c} 在 ${i.config_other_info.parent} 中无法找到，这是不被允许的！父表文件路径：${u}，子表文件路径：`+i.config_other_info.filePath)))}}if(l)return!1;function d(t,n){var i=Object.keys(t);if(n=n||[],i&&i.length)for(let e=0;e<i.length;e++)n.push(i[e]),d(t[i[e]],n);return n}let p={};t.forEach(e=>{let n=J.DataModel.Instance.getParents(e,!0);if(n){n.reverse();let t=p;n.forEach(e=>{t[e]||(t[e]={}),t=t[e]})}}),F.IOUtils.writeTextFile(J.DataModel.Instance.config.origin_extends_url,JSON.stringify(p,null,4),T.LineBreak.CRLF,null,"导出Extends文件失败！ -> {0}, {1}");var m=Object.keys(p);for(let e=0;e<m.length;e++){var y=p[m[e]],D=Object.keys(y);if(D&&D.length)for(let t=0;t<D.length;t++){let n=d(y[D[t]]);n.push(D[t]);for(let e=0;e<D.length&&t!=e;e++){let t=d(y[D[e]]);t.push(D[e]);for(let e=0;e<n.length;e++){var v=n[e],k=J.DataModel.Instance.originConfig[v],S=k&&k.data?Object.keys(k.data):null;for(let e=0;e<t.length;e++){var M,x,I=t[e],O=J.DataModel.Instance.originConfig[I],U=O&&O.data?Object.keys(O.data):null;for(let t=0;t<S.length;t++)for(let e=0;e<U.length;e++)S[t]==U[e]&&(M=J.DataModel.Instance.remark[v].config_other_info.filePath,x=J.DataModel.Instance.remark[I].config_other_info.filePath,console.log(b.default.red(`${v}和${I}继承自同一个父表，不允许存在相同的主键数据${S[t]}。文件路径：${M}，`+x)),l=!0)}}}}}return!l}verifyData(){let n=!1,e=(J.DataModel.Instance.reset(),Object.keys(J.DataModel.Instance.originConfig));for(let r=e.length-1;0<=r;r--){let l=e[r];var i=J.DataModel.Instance.remark[l];if(i.config_other_info){let t=e.filter((e,t)=>{var n;if(t!=r){var i=J.DataModel.Instance.remark[e];if(i.config_other_info){var a=Object.keys(i);for(let e=a.length-1;0<=e;e--)if((null==(n=i[a[e]])?void 0:n.link)==l)return!0}}return!1});if(t.length){var a=i.config_other_info.filePath,o=Object.keys(i);for(let e=o.length-1;0<=e;e--){var s=o[e],s=t.indexOf(null==(s=i[s])?void 0:s.link),f=t[s];-1!=s&&(n=!0,s=J.DataModel.Instance.remark[f].config_other_info.filePath,console.log(b.default.red(l+` 和 ${f} 循环链接（Link）了，请检查！文件路径：${a}，`+s)))}}}}return!n&&!n}}exports.GenOriginModule=t;