"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenCSModule=void 0;const q=e(require("cli-color")),F=e(require("path")),b=require("../utils/IOUtils"),B=require("../utils/StringUtils"),E=require("../DataModel"),a=e(require("fs")),n=require("../utils/CommonUtils"),P=require("../CSTypeEnum"),j=require("../utils/LineBreak"),A=require("../utils/CodeWriter"),d=e(require("crypto-js/enc-base64")),g=e(require("crypto-js/enc-utf8"));class t{static get Instance(){return null==this._instance&&(this._instance=new t),this._instance}gen(t){this._export=E.DataModel.Instance.config.exports.find(e=>e.id==t),this._codeLang=this._export.code_language,console.log(`
================================= 开始生成 ${this._export.id} 配置 =================================
`),b.IOUtils.deleteFolderFileByCondition(this._export.export_script_url,e=>{if(".meta"!=F.default.extname(e))return!0}),b.IOUtils.makeDir(this._export.export_script_url),b.IOUtils.copy(`templates/${this._export.id}/scripts/`,this._export.export_script_url),this._configNames=E.DataModel.Instance.getConfigNamesAndCutDataByConfigType(this._export.id),this._configSplitor=E.DataModel.Instance.config.export_data_splitor,E.DataModel.Instance.config.export_data_splitor_random_enabled&&(this._configSplitor=B.StringUtils.genPassword(8,!0,!0,!1,!0));let e=this.genEnum();return(e=(e=e&&this.genItemAndVertical())&&this.genMgr())&&b.IOUtils.deleteFolderFileByCondition(this._export.export_script_url,t=>{if(".meta"==F.default.extname(t)){var n=F.default.dirname(t);let e=F.default.basename(t);n=F.default.join(n,e.split(".")[0]+"."+this._export.script_suffix);return a.default.existsSync(n)?void 0:(console.log(t,"已被删除"),!0)}}),e=e&&this.genConfigText()}genEnum(){var t=n.CommonUtils.getTemplate(this._export.id,"ConfigEnum.txt");let i=Object.keys(E.DataModel.Instance.enum);i=i.filter(e=>!E.DataModel.Instance.remark[e].generate||0<=E.DataModel.Instance.remark[e].generate.indexOf(this._export.id));for(let e=0;e<i.length;e++){var r=i[e];let n=E.DataModel.Instance.enum[r],a=new A.CodeWriter;n.forEach((e,t)=>{a.add(2,"/**"),a.add(2," * "+e.annotation),a.add(2," */");t=t==n.length-1;a.add(2,e.key+" = "+e.value+(t?"":","),!t)});var o=B.StringUtils.format(t,r,a.content);b.IOUtils.writeTextFile(F.default.join(this._export.export_script_url,r+"."+this._export.script_suffix),o,j.LineBreak.CRLF,"导出枚举类脚本成功！-> {0}")}return!0}genItemAndVertical(){var d=n.CommonUtils.getTemplate(this._export.id,"ConfigItem.txt"),i=n.CommonUtils.getTemplate(this._export.id,"ConfigSingle.txt");for(let e=0;e<this._configNames.length;e++){var g=this._configNames[e],r=E.DataModel.Instance.originConfig[g],c=E.DataModel.Instance.remark[g],f=c.config_other_info&&c.config_other_info.parent&&E.DataModel.Instance.remark[c.config_other_info.parent],p=E.DataModel.Instance.getParents(g);let n;f&&(n=B.StringUtils.convertToLowerCamelCase(p[p.length-1]));var p=f&&c.config_other_info.parent+E.DataModel.Instance.config.export_item_suffix,_=c.config_other_info;if(r.fixed_keys){var u=E.DataModel.Instance.getConfigUniqueKeyType(g,this._codeLang),m=g+E.DataModel.Instance.config.export_item_suffix;let e="",a=new A.CodeWriter,i="",r="",o=new A.CodeWriter,s=(f&&(e=" : "+p),[["uniqueKey",u,n]]);if(_&&!_.isSingleMainKey){var h=_.mainKeyNames;for(let e=0;e<h.length;e++){var y=h[e],y=E.DataModel.Instance.getConfigKeyType(g,y,this._codeLang),x=E.DataModel.Instance.getMainKeyVarName(e+1);s.push([x,y,n])}for(let e=0;e<h.length;e++){var I=h[e],C=E.DataModel.Instance.getConfigKeyType(g,I,this._codeLang);s.push([I,C,n])}}let t=E.DataModel.Instance.getConfigFixedKeys(g,this._codeLang,!0),l=(t=t.filter(t=>!s.find(e=>e[0]==t[0])),s=[...s,...t],E.DataModel.Instance.getConfigFixedKeys(g,this._codeLang));if(!f&&(a.add(2,"/// <summary>"),a.add(2,"/// 唯一主键"),a.add(2,"/// </summary>"),a.add(2,`public ${u} UniqueKey { private set; get; }`),o.add(3,"UniqueKey = uniqueKey;"),_&&!_.isSingleMainKey)){var $=_.mainKeyNames;for(let e=0;e<$.length;e++){var M=$[e],M=E.DataModel.Instance.getConfigKeyType(g,M,this._codeLang),v=(a.add(2,"/// <summary>"),a.add(2,`/// 第${e+1}主键`),a.add(2,"/// </summary>"),E.DataModel.Instance.getMainKeyVarName(e+1)),D=B.StringUtils.convertToUpperCamelCase(v);a.add(2,`public ${M} ${D} { private set; get; }`),o.add(3,D+` = ${v};`)}}for(let n=0;n<s.length;n++){var L=s[n];let t=L[0],e=L[1];var L=L[2],L=E.DataModel.Instance.remark[L]||c,T=null!=l.find(e=>e[0]==t),U=E.DataModel.Instance.isMainKey(g,t),S=B.StringUtils.convertToLowerCamelCase(t),k=B.StringUtils.convertToUpperCamelCase(t),K=T&&(!f||!U);if(K){let e;(e=L&&L[t]?L[t].annotation:e)&&(a.add(2,"/// <summary>"),a.add(2,"/// "+e),a.add(2,"/// </summary>"))}if(L[t]&&L[t].enum){if(e!=P.CSTypeEnum.Int)return console.log(q.default.red("枚举的值不是整数！-> "+g+" -> "+t)),!1;e=L[t].enum,K&&a.add(2,`public ${e} ${k} { private set; get; }`,!1),i+=e+" "+S}else if(L[t]&&L[t].link){L[t].link;var w=L[t].link+E.DataModel.Instance.config.export_item_suffix;if(L[t].linkIsArray){if(e!=P.CSTypeEnum.IntList&&e!=P.CSTypeEnum.StringList)return console.log(q.default.red("链接的值不是整数数组或字符串数组！-> "+g+" -> "+t)),!1;K&&a.add(2,`public IReadOnlyList<${w}> ${k} { private set; get; }`,!1),i+=`IReadOnlyList<${w}> `+S}else K&&a.add(2,`public ${w} ${k} { private set; get; }`,!1),i+=w+" "+S}else K&&a.add(2,`public ${e} ${k} { private set; get; }`,!1),i+=e+" "+S;K&&o.add(3,k+` = ${S};`,!1),!f||T&&!U||(r+=(r?", ":"")+S),n<s.length-1&&(K&&(a.newLine(),o.newLine()),i+=", ")}r=r&&` : base(${r})`;p=B.StringUtils.format(d,m,e,a.content,m,i,r,o.content);b.IOUtils.writeTextFile(F.default.join(this._export.export_script_url,g+E.DataModel.Instance.config.export_item_suffix+"."+this._export.script_suffix),p,j.LineBreak.CRLF,`导出配置Item(${c.config_other_info.sheetType})脚本成功！-> {0}`)}else{let e=new A.CodeWriter,t="",n=new A.CodeWriter;var o=Object.keys(r).length;let a=0;for(const O in r){var s=r[O],s=E.DataModel.Instance.getValueType(s,this._codeLang),l=B.StringUtils.convertToLowerCamelCase(O),N=B.StringUtils.convertToUpperCamelCase(O);e.add(2,`public ${s} ${N} { private set; get; }`,!1),t+=s+" "+l,n.add(3,N+` = ${l};`,!1),a<o-1&&(t+=", ",e.newLine(),n.newLine()),a++}u=B.StringUtils.format(i,g,e.content,g,t,n.content);b.IOUtils.writeTextFile(F.default.join(this._export.export_script_url,g+"."+this._export.script_suffix),u,j.LineBreak.CRLF,`导出配置Item(${c.config_other_info.sheetType})脚本成功！-> {0}`)}}return!0}genMgr(){var e=n.CommonUtils.getTemplate(this._export.id,"ConfigManager.txt");let l=new A.CodeWriter,d=new A.CodeWriter;for(let s=0;s<this._configNames.length;s++){const w=this._configNames[s];let a=E.DataModel.Instance.originConfig[w];var g=w+E.DataModel.Instance.config.export_item_suffix,c=E.DataModel.Instance.remark[w];let i=E.DataModel.Instance.getParents(w),e=i?[...i].reverse():null;var f=i?i.length:0;let t=[];f&&i.forEach(e=>{t.push(E.DataModel.Instance.remark[e])});var p=c.config_other_info,_=B.StringUtils.convertToLowerCamelCase(w),u=B.StringUtils.convertToUpperCamelCase(w);d.add(3,"// "+w),d.add(3,`section = sections[${s}];`),d.add(3,'lines = Regex.Split(section, "\\r\\n");');let r=a.fixed_keys;if(r){var m,h=E.DataModel.Instance.getConfigUniqueKeyType(w,this._codeLang);let a=1;p&&!p.isSingleMainKey&&(m=p.mainKeyNames,a=m.length+1),f||l.add(2,`public static BaseConfig<${h}, ${g}> ${w} { private set; get; }`,!1);let n,o=(f?(n="dict"+s,m=B.StringUtils.convertToLowerCamelCase(i[i.length-1])+"Data",d.add(3,`var ${n} = ${m};`)):(n=_+"Data",d.add(3,`Dictionary<${h}, ${g}> ${n} = new Dictionary<${h}, ${g}>();`)),d.add(3,`for (int n = 0; n < lines.Length - 1; n += ${r.length+a})`),d.add(3,"{"),f&&e.forEach((e,t)=>{e+=E.DataModel.Instance.config.export_item_suffix;d.add(4,`var parentItem${t+1} = ${n}[${B.StringUtils.format(E.DataModel.Instance.getParseFuncNameByType(E.DataModel.Instance.getConfigUniqueKeyType(w,this._codeLang,!1),this._codeLang),"lines[n]")}] as ${e};`)}),"");if(c.config_other_info&&c.config_other_info.mainKeyOnlyOneAndIsEnum&&(o+=`(${h}) `),o+=B.StringUtils.format(E.DataModel.Instance.getParseFuncNameByType(E.DataModel.Instance.getConfigUniqueKeyType(w,this._codeLang,!1),this._codeLang),"lines[n]"),p&&!p.isSingleMainKey){o+=", ";var y=p.mainKeyNames;for(let e=0;e<y.length;e++){var x=y[e],x=E.DataModel.Instance.getConfigKeyType(w,x,this._codeLang);o+=B.StringUtils.format(E.DataModel.Instance.getParseFuncNameByType(x,this._codeLang),`lines[n + ${e+1}]`),e!=y.length-1&&(o+=", ")}}if(0<r.length&&(o+=", "),f){let r=[];e.forEach((e,t)=>{var n=E.DataModel.Instance.originConfig[e].fixed_keys;for(let e=0;e<n.length;e++){var a,i=n[e];-1==r.indexOf(i)&&(a=B.StringUtils.convertToUpperCamelCase(i),o+=`parentItem${t+1}.${a}, `,r.push(i))}})}for(let t=0;t<r.length;t++){var I=r[t];let n=!1;if(f)for(let t=i.length-1;!n&&0<=t;t--){var C=i[t];let e=E.DataModel.Instance.originConfig[C].fixed_keys;-1!=e.indexOf(I)&&(n=!0)}if(!n){let e=E.DataModel.Instance.getConfigKeyType(w,I,this._codeLang);if(c[I]&&c[I].enum){if(e!=P.CSTypeEnum.Int)return console.log(q.default.red("枚举的值不是整数！-> "+w+" -> "+I)),!1;e=c[I].enum,o=(o+=`(${e}) `)+B.StringUtils.format(E.DataModel.Instance.getParseFuncNameByType(P.CSTypeEnum.Int,this._codeLang),`lines[n + ${t+a}]`)}else if(c[I].link){var $=c[I].link;if(c[I].linkIsArray){if(e!=P.CSTypeEnum.IntList&&e!=P.CSTypeEnum.StringList)return console.log(q.default.red("链接的值不是整数数组或字符串数组！-> "+w+" -> "+I)),!1;var M=E.DataModel.Instance.getConfigUniqueKeyType(c[I].link,this._codeLang),v=c[I].link+E.DataModel.Instance.config.export_item_suffix;o+=`ConfigUtility.GetLinkedConfigs<${M}, ${v}>(${B.StringUtils.format(E.DataModel.Instance.getParseFuncNameByType(e,this._codeLang),`lines[n + ${t+a}]`)}, ${c[I].link})`}else o+=`${$}.Get(lines[n + ${t+a}])`}else o+=B.StringUtils.format(E.DataModel.Instance.getParseFuncNameByType(e,this._codeLang),`lines[n + ${t+a}]`);t<r.length-1&&(o+=", ")}}if(d.add(4,`var item = new ${g}(${o});`),d.add(4,n+"[item.UniqueKey] = item;"),d.add(3,"}"),f||d.add(3,`${w} = new BaseConfig<${h}, ${g}>("${w}", ${n});`,!1),p&&!p.isSingleMainKey){var D=B.StringUtils.convertToUpperCamelCase(E.DataModel.MainKeyVarName),L=(l.newLine(),p.mainKeyNames),_=E.DataModel.Instance.getConfigCollectionTypeByIndex(w,this._codeLang),T=""+u+E.DataModel.Instance.config.export_collection_suffix;l.add(2,`public static ${_} ${T} { private set; get; }`),d.newLine(),d.add(3,T+` = new ${_}();`),d.add(3,`foreach (var keyValuePair in ${u}.Data)`),d.add(3,"{"),d.add(4,"var item = keyValuePair.Value;");for(let n=1;n<L.length;n++){d.add(4,"if (!"+T,!1);let t=n;for(let e=0;e<t;e++){var U=e+1;e!=t-1?d.add(0,`[item.${D}${U}]`,!1):d.add(0,`.ContainsKey(item.${D}${U})`,!1)}d.add(0,")"),d.add(5,T,!1),t=n;for(let e=0;e<t;e++){var S,k=e+1;e!=t-1?d.add(0,`[item.${D}${k}]`,!1):(S=E.DataModel.Instance.getConfigCollectionTypeByIndex(w,this._codeLang,n,L.length-1),d.add(0,`[item.${D}${k}] = new ${S}();`))}}d.add(4,T,!1);for(let e=0;e<L.length;e++){var K=e+1;e!=L.length-1?d.add(0,`[item.${D}${K}]`,!1):d.add(0,`[item.${D}${K}] = item;`)}d.add(3,"}")}}else{l.add(2,`public static ${w} ${w} { private set; get; }`,!1),r=Object.keys(a);let n="";r.forEach((e,t)=>{e=a[e],e=E.DataModel.Instance.getValueType(e,this._codeLang);n+=B.StringUtils.format(E.DataModel.Instance.getParseFuncNameByType(e,this._codeLang),`lines[${t}]`),t<r.length-1&&(n+=", ")}),d.add(3,`${w} = new ${w}("${w}", ${n});`,!1)}s<this._configNames.length-1&&(l.newLine(),d.newLine(2))}e=B.StringUtils.format(e,l.content,d.content);return b.IOUtils.writeTextFile(F.default.join(this._export.export_script_url,this._export.export_config_manager_name+"."+this._export.script_suffix),e,j.LineBreak.CRLF,`成功导出配置管理类脚本（${this._export.export_config_manager_name}）-> {0}`),!0}genConfigText(){let n=new A.CodeWriter;for(let e=0;e<this._configNames.length;e++){var a=this._configNames[e],t=E.DataModel.Instance.originConfig[a],i=t.fixed_keys;if(0<e&&n.add(0,"#",!1),i){var r=t.data;for(const s in r){var o=r[s];let e=isNaN(+s)?s:+s,t=(n.add(0,e),isNaN(+s)&&e.split("_"));t&&1<t.length&&E.DataModel.Instance.remark[a]&&E.DataModel.Instance.remark[a].config_other_info&&E.DataModel.Instance.remark[a].config_other_info.mainKeySubs&&t.length==E.DataModel.Instance.remark[a].config_other_info.mainKeySubs.length&&t.forEach(e=>{e=isNaN(+e)?e:+e,n.add(0,e)});for(let t=0;t<o.length;t++){let e=o[t];e=Array.isArray(e)?JSON.stringify(e):e.toString(),n.add(0,""+e)}}}else for(const l in t){let e=t[l];e=Array.isArray(e)?JSON.stringify(e):null!=e?e.toString():"",n.add(0,""+e)}}var e=g.default.parse(n.content),e=d.default.stringify(e);return b.IOUtils.writeTextFile(this._export.export_url,e,null,"导出配置文本成功！-> {0}"),!0}}exports.GenCSModule=t;