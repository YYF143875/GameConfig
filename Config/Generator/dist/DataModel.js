"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.DataModel=void 0;const f=e(require("cli-color")),t=e(require("fs")),n=require("./utils/IOUtils"),y=require("./TSTypeEnum"),C=require("./utils/CommonUtils"),m=require("./CSTypeEnum"),c=require("./utils/StringUtils"),h=require("./SheetType"),S=require("./CodeLanguageEnum");class p{static get Instance(){return null==this._instance&&(this._instance=new p),this._instance}get config(){var e;return this._config||(e=t.default.readFileSync("Config.json",{encoding:"utf-8"}),this._config=JSON.parse(e)),this._config}get originConfigURL(){return this.config.origin_json_url}get remarkURL(){return this.config.origin_remark_url}get enumURL(){return this.config.origin_enum_url}get originConfig(){var e;return this._originConfig||n.IOUtils.fileOrFolderIsExsit(this.originConfigURL)&&(e=t.default.readFileSync(this.originConfigURL,{encoding:"utf-8"}),this._originConfig=JSON.parse(e)),this._originConfig}get remark(){var e;return this._remark||n.IOUtils.fileOrFolderIsExsit(this.remarkURL)&&(e=t.default.readFileSync(this.remarkURL,{encoding:"utf-8"}),this._remark=JSON.parse(e)),this._remark}get enum(){var e;return this._enum||n.IOUtils.fileOrFolderIsExsit(this.enumURL)&&(e=t.default.readFileSync(this.enumURL,{encoding:"utf-8"}),this._enum=JSON.parse(e)),this._enum}reset(){this._originConfig=null,this._remark=null,this._enum=null}isConventionType(e,t){switch(t){case S.CodeLanguageEnum.TS:for(var n in y.TSTypeEnum)if(y.TSTypeEnum[n]==e)return!0;break;case S.CodeLanguageEnum.CS:}return!1}getConfigUniqueKeyType(e,t,n=!0){let i;switch(t){case S.CodeLanguageEnum.TS:i=y.TSTypeEnum;break;case S.CodeLanguageEnum.CS:i=m.CSTypeEnum}var e=this.remark[e];return 1==e.config_other_info.mainKeySubs.length?(e=e[e.config_other_info.mainKeyNames[0]],n&&e.enum?e.enum:e.fixedType?"int"==e.fixedType&&t===S.CodeLanguageEnum.TS?y.TSTypeEnum.Int:e.fixedType:void 0):i.String}getFixedType(e,t,n){let r;switch(n){case S.CodeLanguageEnum.TS:r=y.TSTypeEnum;break;case S.CodeLanguageEnum.CS:r=m.CSTypeEnum}n=this.remark[e];let a=n&&n[t].fixedType;if(a){var s,e=Array.isArray(a);for(let i=(a=e?a:[a]).length-1;0<=i;i--){let e=a[i],t=e.trim(),n=0;for(;-1!=t.indexOf("[]");)t=t.substring(0,t.length-2),n++;n?(s=c.StringUtils.convertToUpperCamelCase(t),a[i]=r[s+"List"+(1<n?n:"")]):(s=c.StringUtils.convertToUpperCamelCase(e),a[i]=r[""+s])}e||(a=a[0])}return a}getAnyDataValue(e,t){let n="",i=this.originConfig[e];var r=i.fixed_keys.indexOf(t);for(const s in i.data){var a=i.data[s];if(""===n){a=a[r];if(""!==a){n=a;break}}}return n}getConfigKeyType(e,i,r){let a=this.getFixedType(e,i,r);if(a){if(!Array.isArray(a))return a;{let t=!0,n;for(let e=a.length-1;0<=e&&t;e--){n=a[e];for(let e=a.length-1;0<=e&&t;e--){var s=a[e];n!=s&&(t=!1)}}switch(r){case S.CodeLanguageEnum.TS:return t?n+"[]":"any[]";case S.CodeLanguageEnum.CS:if(t){let e;for(var o in m.CSTypeEnum)m.CSTypeEnum[o]==n&&(e=o);return e==m.CSTypeEnum.Bool||e==m.CSTypeEnum.Int||e==m.CSTypeEnum.Float||e==m.CSTypeEnum.String?m.CSTypeEnum[e+"List"]:(u=e.split("List"),m.CSTypeEnum[u[0]+"List"+(u[1]+1)])}var u=this.remark[e],u=null!=u&&u.config_other_info?u.config_other_info.filePath:null==u?void 0:u.filePath;console.log(f.default.red(`C#不支持any类型！你清醒一点！表名：${e}，字段：${i}，文件路径：`+u))}}}return a=this.getAnyDataValue(e,i),a=this.getValueType(a,r)}getValueType(i,r,a){if(a)try{i=JSON.parse(i)}catch(e){console.log(f.default.yellow("获取值类型，解析JSON出错，",i))}let s;switch(r){case S.CodeLanguageEnum.TS:s=y.TSTypeEnum;break;case S.CodeLanguageEnum.CS:s=m.CSTypeEnum}if(""===i)switch(r){case S.CodeLanguageEnum.TS:return y.TSTypeEnum.Any;case S.CodeLanguageEnum.CS:return m.CSTypeEnum.String}if(!0===i||!1===i)return s.Bool;if("number"==typeof i)switch(r){case S.CodeLanguageEnum.TS:return y.TSTypeEnum.Int;case S.CodeLanguageEnum.CS:return C.CommonUtils.numIsInt(i)?m.CSTypeEnum.Int:m.CSTypeEnum.Float}if("string"==typeof i)return s.String;if(Array.isArray(i)){if(0==i.length)switch(r){case S.CodeLanguageEnum.TS:return y.TSTypeEnum.AnyList;case S.CodeLanguageEnum.CS:console.log(f.default.red("C#不支持解析空数组类型！"))}var o,u,g=this.getArrayInfo(i,r);let t=Object.keys(g).length<=1,n=0;if(t){let e=[];for(var l in g)for(o in g[l])+o>n&&(n=+o),-1==e.indexOf(+o)&&e.push(+o);1<e.length&&(t=!1)}let e;if(!t||1==(a=Object.keys(g)).length&&(e=a[0]),t)return a=1<n?n:"",u=c.StringUtils.convertToUpperCamelCase(e),s[u+"List"+a];switch(r){case S.CodeLanguageEnum.TS:return y.TSTypeEnum.AnyList;case S.CodeLanguageEnum.CS:console.log(f.default.red("C#不支持Any类型的数组！"))}}if(i instanceof Object)switch(r){case S.CodeLanguageEnum.TS:return y.TSTypeEnum.Any;case S.CodeLanguageEnum.CS:console.log(f.default.red("C#不支持Any类型！"))}}getArrayInfo(e,n,i,r){return null==i&&(i={}),null==r&&(r=1),Array.isArray(e)&&e.forEach((e,t)=>{Array.isArray(e)?this.getArrayInfo(e,n,i,r+1):(e=this.getValueType(e,n))&&(i[e]||(i[e]={}),i[e][r]||(i[e][r]=0),i[e][r]++)}),i}getParents(e){let t,n=this.remark[e];for(;n;){var i=n.config_other_info.parent;n=i?(t?t.push(i):t=[i],this.remark[i]):null}return t}getConfigLinks(e){let t;var n,i=this.remark[e];for(n in i){var r=i[n].link;r&&(t?t.push(r):t=[r])}return t}getMainKeyVarName(e){return p.MainKeyVarName+e}isMainKey(e,t){if(t.substring(0,p.MainKeyVarName.length)==p.MainKeyVarName)return!0;let n=this.remark[e];return!(null===n||void 0===n||!n.config_other_info)&&-1!=n.config_other_info.mainKeyNames.indexOf(t)}getConfigNamesAndCutDataByConfigType(r){let g=Object.keys(this.originConfig);for(let t=g.length-1;0<=t;t--){var a=g[t];let i=this.originConfig[a];var s=this.remark[a];let e=!1;if(0==Object.keys(s).length)e=!0;else{var o=(null==(a=s.config_other_info)?void 0:a.sheetType)||s.sheetType;let n;o==h.SheetType.Horizontal?n=i.fixed_keys:o==h.SheetType.Vertical&&(n=Object.keys(i));for(let t=n.length-1;0<=t;t--){var u=n[t];let e=s[u].generate;if(e&&Array.isArray(e)&&-1==e.indexOf(r))if(n.splice(t,1),o==h.SheetType.Horizontal)for(var l in i.data){let e=i.data[l];e.splice(t,1)}else delete i[u]}0==n.length&&(e=!0)}e&&g.splice(t,1)}for(;;){let s,o,u;for(let a=g.length-1;!s&&0<=a;a--)for(let r=g.length-1;!s&&0<=r;r--)if(a!=r){var f=g[a],y=g[r];let e=this.getConfigLinks(f),t=this.getConfigLinks(y),n=(e&&-1!=e.indexOf(y)?a<r&&(s=!0,o=a,u=r):t&&-1!=t.indexOf(f)&&r<a&&(s=!0,o=a,u=r),this.getParents(f)),i=this.getParents(y);n&&-1!=n.indexOf(y)?a<r&&(s=!0,o=a,u=r):i&&-1!=i.indexOf(f)&&r<a&&(s=!0,o=a,u=r)}if(!s)break;var e=g[u];g[u]=g[o],g[o]=e}return g}getConfigFixedKeys(e,a,t){let n=[],s=(t&&((n=this.getParents(e))?n.reverse():n=[]),n.push(e),[]);return n.forEach(e=>{var t=this.originConfig[e],n=this.remark[e],i=(null==(i=n.config_other_info)?void 0:i.sheetType)||n.sheetType;let r;i==h.SheetType.Horizontal?r=t.fixed_keys:i==h.SheetType.Vertical&&(r=Object.keys(t)),r.forEach(t=>{s.find(e=>e[0]==t)||s.push([t,this.getConfigKeyType(e,t,a),e])})}),s}getConfigCollectionTypeByIndex(t,n,i,r){var a=this.remark[t].config_other_info.mainKeyNames,s=t+p.Instance.config.export_item_suffix;i=i||0,r=r||a.length-1;let o;switch(n){case S.CodeLanguageEnum.TS:o="Map";break;case S.CodeLanguageEnum.CS:o="Dictionary"}let u="",g="";for(let e=i;e<=r;e++){var l=a[e],l=p.Instance.getConfigKeyType(t,l,n);u+=o+`<${l}, `,e==r&&(u+=""+s),g+=">"}return u+=g}getParseFuncNameByType(e,t){switch(t){case S.CodeLanguageEnum.TS:console.log(f.default.red("TS没有这个烦恼，是从哪里调进来的？！你清醒一点！"));break;case S.CodeLanguageEnum.CS:switch(e){case m.CSTypeEnum.Bool:return"ConfigUtility.ParseBool({0})";case m.CSTypeEnum.Int:return"ConfigUtility.ParseInt({0})";case m.CSTypeEnum.Float:return"ConfigUtility.ParseFloat({0})";case m.CSTypeEnum.String:return"{0}";case m.CSTypeEnum.BoolList:return"ConfigUtility.ParseBoolList({0})";case m.CSTypeEnum.IntList:return"ConfigUtility.ParseIntList({0})";case m.CSTypeEnum.FloatList:return"ConfigUtility.ParseFloatList({0})";case m.CSTypeEnum.StringList:return"ConfigUtility.ParseStringList({0})";case m.CSTypeEnum.BoolList2:return"ConfigUtility.ParseBoolList2({0})";case m.CSTypeEnum.IntList2:return"ConfigUtility.ParseIntList2({0})";case m.CSTypeEnum.FloatList2:return"ConfigUtility.ParseFloatList2({0})";case m.CSTypeEnum.StringList2:return"ConfigUtility.ParseStringList2({0})";case m.CSTypeEnum.BoolList3:return"ConfigUtility.ParseBoolList3({0})";case m.CSTypeEnum.IntList3:return"ConfigUtility.ParseIntList3({0})";case m.CSTypeEnum.FloatList3:return"ConfigUtility.ParseFloatList3({0})";case m.CSTypeEnum.StringList3:return"ConfigUtility.ParseStringList3({0})";case m.CSTypeEnum.BoolList4:return"ConfigUtility.ParseBoolList4({0})";case m.CSTypeEnum.IntList4:return"ConfigUtility.ParseIntList4({0})";case m.CSTypeEnum.FloatList4:return"ConfigUtility.ParseFloatList4({0})";case m.CSTypeEnum.StringList4:return"ConfigUtility.ParseStringList4({0})";case m.CSTypeEnum.BoolList5:return"ConfigUtility.ParseBoolList5({0})";case m.CSTypeEnum.IntList5:return"ConfigUtility.ParseIntList5({0})";case m.CSTypeEnum.FloatList5:return"ConfigUtility.ParseFloatList5({0})";case m.CSTypeEnum.StringList5:return"ConfigUtility.ParseStringList5({0})"}}}}(exports.DataModel=p).MainKeyVarName="mainKey";