"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenOriginModule=void 0;const b=e(require("cli-color")),o=e(require("path")),a=e(require("node-xlsx")),E=require("../SpecialType"),L=require("../SheetType"),F=require("../utils/IOUtils"),A=require("../utils/StringUtils"),J=require("../DataModel"),j=require("../utils/CommonUtils"),T=require("../utils/LineBreak");class t{constructor(){this._sheetFileExts=[".xls",".xlsx"]}static get Instance(){return null==this._instance&&(this._instance=new t),this._instance}gen(){this._fileList=[],F.IOUtils.findFile(J.DataModel.Instance.config.excel_url,this._sheetFileExts,this._fileList),this._fileList=this._fileList.filter(e=>-1==e.indexOf("~$")),this._finalJsonDict={},this._remark={},this._enumSheets=[],this._hSheets=[],this._vSheets=[],console.log(`
================================= 开始生成源数据 =================================
`);let e=this.collectAndPreproccessSheet();return e=(e=(e=(e=(e=(e=e&&this.proccessEnumSheet())&&this.proccessHSheet())&&this.proccessVSheet())&&this.exportData())&&this.checkAndExportExtendsTreeData())&&this.verifyData()}convertGenerateToArray(e){let t;if(e)if(isNaN(e)){var n=e.split("|");for(let e=0;e<n.length;e++){var i=+n[e];isNaN(i)||(null==t?t=[i]:t.push(i))}}else t=[+e];return t}canUseOldData(t){var n;let i=!1;if(J.DataModel.Instance.remark&&J.DataModel.Instance.originConfig&&J.DataModel.Instance.enum)for(var l in J.DataModel.Instance.remark){l=J.DataModel.Instance.remark[l];if((l.filePath||(null==(n=null==l?void 0:l.config_other_info)?void 0:n.filePath))==t){let e;l.filePath?(e=l.fileMD5,t=l.filePath):l.config_other_info&&(e=l.config_other_info.fileMD5,t=null==(n=null==l?void 0:l.config_other_info)?void 0:n.filePath);l=F.IOUtils.getFileMD5(t);l&&l==e&&(i=!0)}}return i}getUniqueKey(n,i,l,e){let a="",r,o;for(let t=0;t<n.length;t++){var s=n[t];let e=i[s];null==(e=null==e?l[s]:e)&&(r=!0),null!=e&&(o=!0,a+=e,t<n.length-1&&(a+="_"))}return o&&r?{error:e+"主键数据不完整！数据："+i}:a?{result:a}:void 0}collectAndPreproccessSheet(){var t;for(let e=0;e<this._fileList.length;e++){let d=this._fileList[e];var _=F.IOUtils.getFileMD5(d);if(!this.canUseOldData(d)){console.log(`正在解析 ${d} `+b.default.green(`<${_}>`));var n=a.default.parse(d);if(n&&n.length)for(let e=0;e<n.length;e++){let c=n[e].data,g=c&&c[0];if(g){let t=0;for(let e=0;e<g.length&&null==g[e];e++)t++;g=g&&g.filter(e=>null!=e);for(let e=0;e<t;e++)g.unshift(null)}var p=g&&g[0];let u=g&&g[1];if(p&&u){u=A.StringUtils.convertToUpperCamelCase(u);let h=A.StringUtils.convertToUpperCamelCase(p);switch(u){case L.SheetType.Horizontal:{let e=g&&g[2],l=(e=e&&A.StringUtils.convertToUpperCamelCase(e)+J.DataModel.Instance.config.export_suffix,h+=J.DataModel.Instance.config.export_suffix,c[1]),a={};var m=c[2];let i=c[3];var y,D=c[4],v=c[5],k=c[6];let n=[],r=[];for(let e=l.length-1;0<=e;e--){if(l[e]&&-1==l[e].indexOf("#"))return console.log(b.default.red(`${h}的${l[e]}字段没有声明类型！文件路径：`+d)),!1;!l[e]||"#"==l[e][0]||(y=l[e]&&l[e].split("#"))&&1<y.length&&(l[e]=y[0],a[l[e]]=y[1])}let t=c.slice(7,c.length);t=t.filter(e=>e.filter(e=>null!=e).length);for(let e=0;e<l.length;e++){var S=l[e];if(l.indexOf(S)!=e&&0<=l.indexOf(S))return console.log(b.default.red(p+`检测到重复的键! 键：${S}，文件路径：`+d)),!1}for(let n=0;n<i.length;n++){let t=i[n];if(isNaN(+t))i[n]=t=null;else{if(j.CommonUtils.numIsFloat(t))return console.log(b.default.red(`${p}主键不支持浮点数! 主键：${l[n]}，文件路径：`+d)),!1;for(let e=0;e<i.length;e++)if(n!=e&&t==i[e])return console.log(b.default.red(`${p}检测到重复的主键! 主键：${l[n]}，文件路径：`+d)),!1;if(v[n])return console.log(b.default.red(`${p}的主键设置了默认值，这是不被允许的。 主键：${l[n]}，文件路径：`+d)),!1}}var M,x=i.filter(e=>!isNaN(e)),I=Math.min.apply(null,x),O=Math.max.apply(null,x);for(let t=I;t<=O;t++){var U=i.findIndex(e=>e==t);0<=U&&(n.push(U),r.push(l[U]))}if(0==n.length)return console.log(b.default.red(p+"没有主键! 文件路径："+d)),!1;let o={},s=[],f={};for(let i=0;i<m.length;i++){const K=m[i];if(null!=K){var T=K.split("#");let e=T[0],n=T[1];var $=l[i];let t=a[$];switch(e=e&&A.StringUtils.convertToLowerCamelCase(e)){case E.SpecialType.Array:if(!o[n]){let t=[];for(let e=0;e<m.length;e++){var N=m[e];if(N==K&&(t.push(e),s.indexOf(e)<0))for(s.push(e);l.length<e+1;)l.push(null)}t.length&&(o[n]={cols:t})}break;case E.SpecialType.Link:var P="[]"===t.substring(t.length-2,t.length),C=n.replace("[]","").trim();f[$]={linkSheetName:C,linkSheetNameUppercase:A.StringUtils.convertToUpperCamelCase(C)+J.DataModel.Instance.config.export_suffix,isArray:P}}}}for(M in o){let e=o[M].cols,n=[];e.forEach(e=>{let t=l[e];t&&"#"==t[0]?(e=t.split("#"),n.push(e[1])):n.push(null)}),0<n.length&&!n.find(e=>null==e)&&(a[M]=n)}this._hSheets.push({filePath:d,fileMD5:_,sheetType:u,sheetSourceData:c,sheetName:p,sheetNameUppercase:h,parent:e,mainKeySubs:n,mainKeyNames:r,keyNames:l,fixedKeyTypes:a,formats:m,gens:D,defaults:v,annotations:k,sheetContent:t,arrayColAll:s,arrayColDict:o,linkDict:f});break}case L.SheetType.Vertical:{h+=J.DataModel.Instance.config.export_suffix;let a={},r={},o={},s={},e=c.slice(2,c.length);(e=e.filter(e=>e.filter(e=>null!=e).length)).forEach(e=>{if(-1==e[0].indexOf("#"))return console.log(b.default.red(`${h}的${e[0]}字段没有声明类型！文件路径：`+d)),!1;var t=e[0].split("#"),n=t[0],t=1<t.length?t[1]:null,i=this.convertGenerateToArray(e[1]),l=e[2],e=e[3];a[n]=l,t&&(r[n]=t),i&&(o[n]=i),e&&(s[n]=e)}),this._vSheets.push({filePath:d,fileMD5:_,sheetType:u,sheetSourceData:c,sheetName:p,sheetNameUppercase:h,fixedKeyDatas:a,fixedKeyTypes:r,gens:o,annotations:s,sheetContent:e});break}case L.SheetType.Enum:{x=g[2];let e=c.slice(2,c.length);e=e.filter(e=>e.filter(e=>null!=e).length),this._enumSheets.push({filePath:d,fileMD5:_,sheetSourceData:c,sheetName:p,sheetNameUppercase:h,sheetType:u,gens:x,sheetContent:e});break}default:console.log(b.default.red(`不支持的表格配置类型！文件路径：${d}，表名：${p}，表类型：`+u))}}}}else for(var i in J.DataModel.Instance.remark){var l=J.DataModel.Instance.remark[i];if((l.filePath||(null==(t=null==l?void 0:l.config_other_info)?void 0:t.filePath))==d){let e;switch(e=(l.config_other_info||l).sheetType){case L.SheetType.Horizontal:this._hSheets.push({filePath:d,fileMD5:_,sheetType:e,sheetNameUppercase:i,parent:l.config_other_info.parent,isSingleMainKey:l.config_other_info.isSingleMainKey,mainKeySubs:l.config_other_info.mainKeySubs,mainKeyNames:l.config_other_info.mainKeyNames,mainKeyOnlyOneAndIsEnum:l.config_other_info.mainKeyOnlyOneAndIsEnum,isUseOldData:!0,oldData:J.DataModel.Instance.originConfig[i],oldRemarkData:l});break;case L.SheetType.Vertical:this._vSheets.push({filePath:d,fileMD5:_,sheetType:e,sheetNameUppercase:i,isUseOldData:!0,oldData:J.DataModel.Instance.originConfig[i],oldRemarkData:l});break;case L.SheetType.Enum:this._enumSheets.push({filePath:d,fileMD5:_,sheetNameUppercase:i,sheetType:e,gens:l.generate,isUseOldData:!0,oldData:J.DataModel.Instance.enum[i]})}}}}return!0}proccessEnumSheet(){for(let t=0;t<this._enumSheets.length;t++){let e=this._enumSheets[t];var n=e.filePath,i=e.fileMD5;if(e.isUseOldData)e.enumData=e.oldData;else{var l=e.sheetContent;let t=[];for(let e=0;e<l.length;e++){var a=l[e];t.push({key:a[0],value:a[1],annotation:a[2]})}e.enumData=t}this._remark[e.sheetNameUppercase]={filePath:n,fileMD5:i,generate:Array.isArray(e.gens)?e.gens:this.convertGenerateToArray(e.gens),sheetType:e.sheetType}}return!0}proccessHSheet(){var p;for(let e=0;e<this._hSheets.length;e++){let n=this._hSheets[e];var r=n.filePath,m=n.fileMD5;let _=n.sheetNameUppercase;var y=n.parent,D=n.mainKeySubs,v=n.mainKeyNames;if(n.isUseOldData){let e={},i=n.oldData;for(var t in i.data){let n={};i.data[t].forEach((e,t)=>{n[i.fixed_keys[t]]=e}),e[t]=n}if(n.dict=e,n.optimizedDict=i,this._finalJsonDict[_])return S=null!=(S=this._remark[_])&&S.config_other_info?S.config_other_info.filePath:null==S?void 0:S.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${r}，表名：${_}，另一个文件路径：`+S)),!1;this._finalJsonDict[_]=i,this._remark[_]=n.oldRemarkData}else{let s=n.keyNames,o=n.fixedKeyTypes,f=n.formats,h=n.gens,c=n.defaults,g=n.annotations;var k,S,M=n.sheetContent;let e=n.arrayColAll,u=n.arrayColDict,d=n.linkDict,l={},i={},a=[];for(let i=0;i<M.length;i++){var x=M[i],I=this.getUniqueKey(D,x,c,_),O=null==I?void 0:I.result;if(null!=I&&I.error)return console.log(b.default.red(I.error)),!1;if(O){let n={};for(let t=0;t<s.length;t++){var U=s[t];if(0<=e.indexOf(t)){var T=f[t].split("#")[1];if(!n[T]){-1==a.indexOf(T)&&a.push(T);let o=[];for(let e=i;e<M.length;e++){let r=M[e];if((null==(p=this.getUniqueKey(D,r,c,_))?void 0:p.result)&&e!=i)break;{let e=u[T].cols,n=!e.find(e=>!s[e]),i=1<e.length,l=i?n?{}:[]:null,a=!1;if(e.forEach(e=>{let t=r[e];null==t?t=c[e]:a=!0,null!=t&&(i?n?l[s[e]]=t:l.push(t):o.push(t))}),!a)break;i&&(n&&Object.keys(l).length||!n&&l.length)&&o.push(l)}}n[T]=o.length?o:""}}else if(null!=U){-1==a.indexOf(U)&&a.push(U);let e=x[t];e=null==e?null==c[t]?"":c[t]:e;try{var $=JSON.parse(e);e=$}catch(e){}n[U]=e}}l[O]=n}}for(k in i={data:{},fixed_keys:a},l){let t=l[k],n=[];a.forEach(e=>{n.push(t[e])}),i.data[k]=n}if(n.dict=l,n.optimizedDict=i,this._finalJsonDict[_])return N=null!=(S=this._remark[_])&&S.config_other_info?S.config_other_info.filePath:null==S?void 0:S.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${r}，表名：${_}，另一个文件路径：`+N)),!1;this._finalJsonDict[_]=i,this._remark[_]||(this._remark[_]={}),i.fixed_keys&&i.fixed_keys.forEach(t=>{var e,n="",i=s.findIndex(e=>e==t);let l;if(u[t]){let e=u[t].cols;e.forEach(e=>{n?n+=", "+g[e]:n="["+g[e]}),n&&(n+="]"),l=e[0]}else l=i,n=g[i];e=this.convertGenerateToArray(h[l]);let a,r=f[i];i=r&&r.split("#"),i&&2==i.length&&i[0]==E.SpecialType.Enum&&(a=A.StringUtils.convertToUpperCamelCase(i[1])),i=d[t];this._remark[_][t]={fixedType:o[t],generate:e,annotation:n,enum:a,link:i&&i.linkSheetNameUppercase,linkIsArray:i&&i.isArray}});let t;if(1==D.length){let e=f[D[0]];var N=e&&e.split("#");N&&2==N.length&&N[0]==E.SpecialType.Enum&&(t=A.StringUtils.convertToUpperCamelCase(N[1]))}this._remark[_].config_other_info={filePath:r,fileMD5:m,sheetType:n.sheetType,isSingleMainKey:1==D.length,parent:y,mainKeySubs:D,mainKeyNames:v,mainKeyOnlyOneAndIsEnum:1==v.length&&t}}}return!0}proccessVSheet(){for(let t=0;t<this._vSheets.length;t++){let e=this._vSheets[t];var n=e.filePath,i=e.fileMD5,l=e.sheetNameUppercase;if(e.isUseOldData){var a=e.oldData,r=e.oldData;if(e.dict=a,e.optimizedDict=r,this._finalJsonDict[l])return a=null!=(a=this._remark[l])&&a.config_other_info?a.config_other_info.filePath:null==a?void 0:a.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${n}，表名：${l}，另一个文件路径：`+a)),!1;this._finalJsonDict[l]=r,this._remark[l]||(this._remark[l]={}),this._remark[l]=e.oldRemarkData}else{var o=e.fixedKeyDatas,s=e.fixedKeyTypes,f=e.gens,h=e.annotations;let t={};var c,g,u;for(c in o){var d=o[c];let e=0==d?0:d||"";try{e=e.replace(/\t/g,"").replace(/\r/g,"").replace(/\n/g,"");var _=JSON.parse(e);e=_}catch(e){}d=e;t[c]=d}if(a=t,e.dict=t,e.optimizedDict=a,this._finalJsonDict[l])return g=null!=(r=this._remark[l])&&r.config_other_info?r.config_other_info.filePath:null==r?void 0:r.filePath,console.log(b.default.red(`不允许存在相同名称的配置！文件路径：${n}，表名：${l}，另一个文件路径：`+g)),!1;for(u in this._finalJsonDict[l]=a,this._remark[l]||(this._remark[l]={}),t){var p=f[u],m=h[u];this._remark[l][u]={fixedType:s[u],generate:p,annotation:m}}this._remark[l].config_other_info={filePath:n,fileMD5:i,sheetType:L.SheetType.Vertical}}}return!0}exportData(){F.IOUtils.deleteFolderFile(J.DataModel.Instance.config.origin_export_url,!1),F.IOUtils.makeDir(J.DataModel.Instance.config.origin_export_url);let t={};for(let e=0;e<this._enumSheets.length;e++){var n=this._enumSheets[e];t[n.sheetNameUppercase]=n.enumData}var e=JSON.stringify(t,null,4);F.IOUtils.writeTextFile(J.DataModel.Instance.enumURL,e,T.LineBreak.CRLF,null,"导出源配置失败！ -> {0}, {1}");for(let e=0;e<this._hSheets.length;e++){var i=this._hSheets[e],l=JSON.stringify(i.dict,null,4);F.IOUtils.writeTextFile(o.default.join(J.DataModel.Instance.config.origin_export_url,i.sheetNameUppercase+".json"),l,T.LineBreak.CRLF,null,"导出源配置失败！ -> {0}, {1}")}for(let e=0;e<this._vSheets.length;e++){var a=this._vSheets[e],r=JSON.stringify(a.dict,null,4);F.IOUtils.writeTextFile(o.default.join(J.DataModel.Instance.config.origin_export_url,a.sheetNameUppercase+".json"),r,T.LineBreak.CRLF,null,"导出源配置失败！ -> {0}, {1}")}e=JSON.stringify(this._finalJsonDict);return F.IOUtils.writeTextFile(J.DataModel.Instance.originConfigURL,e,T.LineBreak.CRLF,"导出源配置成功！","导出源配置失败！ -> {0}, {1}"),F.IOUtils.writeTextFile(J.DataModel.Instance.remarkURL,JSON.stringify(this._remark,null,4),T.LineBreak.CRLF,null,"导出Remark文件失败！ -> {0}, {1}"),!0}checkAndExportExtendsTreeData(){let a=!1,t=(J.DataModel.Instance.reset(),Object.keys(J.DataModel.Instance.originConfig));for(let e=t.length-1;0<=e;e--){var n=t[e],i=J.DataModel.Instance.remark[n];if(i.config_other_info){let l=[],e=n,t=i;for(;t.config_other_info.parent;){var r=l.indexOf(t.config_other_info.parent),o=J.DataModel.Instance.remark[t.config_other_info.parent];if(!o){a=!0,console.log(b.default.red(`父类不存在！${t.config_other_info.parent}，文件路径：`+t.config_other_info.filePath));break}if(!o.config_other_info){a=!0,console.log(b.default.red(`不允许非水平表被继承！${e}，${t.config_other_info.parent}，文件路径：${t.config_other_info.filePath}，`+o.filePath));break}if(-1!=r){a=!0,l.push(t.config_other_info.parent),t.config_other_info.parent;let n="",i="";l.forEach((e,t)=>{n+=e;e=J.DataModel.Instance.remark[e];i+=e.config_other_info.filePath,t!=l.length-1&&(n+="，",i+="，")}),console.log(b.default.red(`循环继承，这是不被允许的！${n}，文件路径：`+i));break}e=t.config_other_info.parent,t=o,l.push(e)}}}for(let e=t.length-1;0<=e;e--){var l=t[e],s=J.DataModel.Instance.originConfig[l];let i=J.DataModel.Instance.remark[l];var f=J.DataModel.Instance.getParents(l);if(f)for(let e=0;e<f.length;e++){var h=f[e];let t=J.DataModel.Instance.originConfig[h];var c,g=J.DataModel.Instance.remark[h],u=g.config_other_info.filePath;let n=!1;if(i.config_other_info.mainKeyNames.length==g.config_other_info.mainKeyNames.length){for(let e=0;e<i.config_other_info.mainKeyNames.length;e++)if(i.config_other_info.mainKeyNames[e]!=g.config_other_info.mainKeyNames[e]){n=!0;break}}else n=!0;n&&(a=!0,console.log(b.default.red(`${l}继承自${i.config_other_info.parent}，然而他们的主键并不一致，这是不被允许的！父表主键：${g.config_other_info.mainKeyNames}，子表主键：${i.config_other_info.mainKeyNames}，父表文件路径：${u}，子表文件路径：`+i.config_other_info.filePath)));for(let e=0;e<s.fixed_keys.length;e++){var d=s.fixed_keys[e];-1==i.config_other_info.mainKeyNames.indexOf(d)&&-1!=t.fixed_keys.indexOf(d)&&(a=!0,console.log(b.default.red(`${l}继承自${i.config_other_info.parent}，${d}字段重复了，这是不被允许的！父表文件路径：${u}，子表文件路径：`+i.config_other_info.filePath)))}for(c in s.data)t.data[c]||(a=!0,console.log(b.default.red(`${l}继承自${i.config_other_info.parent}，${l} 中的 ${c} 在 ${i.config_other_info.parent} 中无法找到，这是不被允许的！父表文件路径：${u}，子表文件路径：`+i.config_other_info.filePath)))}}if(a)return!1;function _(t,n){var i=Object.keys(t);if(n=n||[],i&&i.length)for(let e=0;e<i.length;e++)n.push(i[e]),_(t[i[e]],n);return n}let p={};t.forEach(e=>{let n=J.DataModel.Instance.getParents(e,!0);if(n){n.reverse();let t=p;n.forEach(e=>{t[e]||(t[e]={}),t=t[e]})}}),F.IOUtils.writeTextFile(J.DataModel.Instance.config.origin_extends_url,JSON.stringify(p,null,4),T.LineBreak.CRLF,null,"导出Extends文件失败！ -> {0}, {1}");var m=Object.keys(p);for(let e=0;e<m.length;e++){var y=p[m[e]],D=Object.keys(y);if(D&&D.length)for(let t=0;t<D.length;t++){let n=_(y[D[t]]);n.push(D[t]);for(let e=0;e<D.length&&t!=e;e++){let t=_(y[D[e]]);t.push(D[e]);for(let e=0;e<n.length;e++){var v=n[e],k=J.DataModel.Instance.originConfig[v],S=k&&k.data?Object.keys(k.data):null;for(let e=0;e<t.length;e++){var M,x,I=t[e],O=J.DataModel.Instance.originConfig[I],U=O&&O.data?Object.keys(O.data):null;for(let t=0;t<S.length;t++)for(let e=0;e<U.length;e++)S[t]==U[e]&&(M=J.DataModel.Instance.remark[v].config_other_info.filePath,x=J.DataModel.Instance.remark[I].config_other_info.filePath,console.log(b.default.red(`${v}和${I}继承自同一个父表，不允许存在相同的主键数据${S[t]}。文件路径：${M}，`+x)),a=!0)}}}}}return!a}verifyData(){let n=!1,e=(J.DataModel.Instance.reset(),Object.keys(J.DataModel.Instance.originConfig));for(let r=e.length-1;0<=r;r--){let a=e[r];var i=J.DataModel.Instance.remark[a];if(i.config_other_info){let t=e.filter((e,t)=>{var n;if(t!=r){var i=J.DataModel.Instance.remark[e];if(i.config_other_info){var l=Object.keys(i);for(let e=l.length-1;0<=e;e--)if((null==(n=i[l[e]])?void 0:n.link)==a)return!0}}return!1});if(t.length){var l=i.config_other_info.filePath,o=Object.keys(i);for(let e=o.length-1;0<=e;e--){var s=o[e],s=t.indexOf(null==(s=i[s])?void 0:s.link),f=t[s];-1!=s&&(n=!0,s=J.DataModel.Instance.remark[f].config_other_info.filePath,console.log(b.default.red(a+` 和 ${f} 循环链接（Link）了，请检查！文件路径：${l}，`+s)))}}}}return!n&&!n}}exports.GenOriginModule=t;