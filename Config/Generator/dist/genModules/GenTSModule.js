"use strict";var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GenTSModule=void 0;const U=e(require("cli-color")),K=e(require("path")),N=require("../utils/IOUtils"),O=require("../utils/StringUtils"),E=require("../DataModel"),q=require("../utils/CommonUtils"),F=require("../TSTypeEnum"),B=require("../utils/LineBreak"),b=require("../utils/CodeWriter");class t{static get Instance(){return null==this._instance&&(this._instance=new t),this._instance}gen(t){this._export=E.DataModel.Instance.config.exports.find(e=>e.id==t),this._codeLang=this._export.code_language,console.log(`
================================= 开始生成 ${this._export.id} 配置 =================================
`),N.IOUtils.deleteFile(this._export.export_url),N.IOUtils.deleteFolderFile(this._export.export_script_url,!1),N.IOUtils.makeDir(this._export.export_script_url),N.IOUtils.copy(`templates/${this._export.id}/scripts/`,this._export.export_script_url),this._configNames=E.DataModel.Instance.getConfigNamesAndCutDataByConfigType(t),this._configSplitor=E.DataModel.Instance.config.export_data_splitor,E.DataModel.Instance.config.export_data_splitor_random_enabled&&(this._configSplitor=O.StringUtils.genPassword(8,!0,!0,!1,!0));let e=this.genEnum();return e=(e=(e=e&&this.genItemAndVertical())&&this.genMgr())&&this.genConfigText()}genEnum(){var t=q.CommonUtils.getTemplate(this._export.id,"ConfigEnum.txt");let a=Object.keys(E.DataModel.Instance.enum);a=a.filter(e=>!E.DataModel.Instance.remark[e].generate||0<=E.DataModel.Instance.remark[e].generate.indexOf(this._export.id));for(let e=0;e<a.length;e++){var o=a[e];let n=E.DataModel.Instance.enum[o],i=new b.CodeWriter;n.forEach((e,t)=>{i.add(1,"/**"),i.add(1," * "+e.annotation),i.add(1," */"),q.CommonUtils.numIsInt(+e.value)?i.add(1,e.key+" = "+e.value,!1):i.add(1,`${e.key} = "${e.value}"`,!1),t<n.length-1&&i.add(0,",")});var r=O.StringUtils.format(t,o,i.content);N.IOUtils.writeTextFile(K.default.join(this._export.export_script_url,o+"."+this._export.script_suffix),r,B.LineBreak.CRLF,"导出枚举类脚本成功！-> {0}")}return!0}genItemAndVertical(){var t=q.CommonUtils.getTemplate(this._export.id,"ConfigItem.txt"),n=q.CommonUtils.getTemplate(this._export.id,"ConfigSingle.txt");for(let e=0;e<this._configNames.length;e++){var o=this._configNames[e],r=E.DataModel.Instance.originConfig[o],s=E.DataModel.Instance.remark[o],d=s.config_other_info&&s.config_other_info.parent&&E.DataModel.Instance.remark[s.config_other_info.parent],l=d&&s.config_other_info.parent+E.DataModel.Instance.config.export_item_suffix,f=s.config_other_info;if(r.fixed_keys){var g=E.DataModel.Instance.getConfigUniqueKeyType(o,this._codeLang),c=o+E.DataModel.Instance.config.export_item_suffix;let e="",i=new b.CodeWriter,a=new b.CodeWriter;if(d&&(i.add(0,`import { ${l} } from "./${l}";`),e=" extends "+l),!s.config_other_info.parent&&(a.add(1,"/**"),a.add(1," * 唯一Key"),a.add(1," **/"),a.add(1,`readonly uniqueKey: ${g};`),f&&!f.isSingleMainKey)){var _=f.mainKeyNames;for(let e=0;e<_.length;e++){var m=_[e],m=E.DataModel.Instance.getConfigKeyType(o,m,this._codeLang);a.add(1,"/**"),a.add(1,` * 第${e+1}主键`),a.add(1," **/"),a.add(1,`readonly ${E.DataModel.Instance.getMainKeyVarName(e+1)}: ${m};`)}}for(let n=0;n<r.fixed_keys.length;n++){var h=r.fixed_keys[n];if(!d||!d[h]){var p=O.StringUtils.convertToLowerCamelCase(h);let e,t=((e=s&&s[h]?s[h].annotation:e)&&(a.add(1,"/**"),a.add(1," * "+e),a.add(1," **/")),E.DataModel.Instance.getConfigKeyType(o,h,this._codeLang));if(s[h]&&s[h].enum){if(t!=F.TSTypeEnum.Int&&t!=F.TSTypeEnum.String)return console.log(U.default.red("枚举的值不是整数或字符串！-> "+t+" "+F.TSTypeEnum.Int+" "+o+" -> "+h)),!1;t=s[h].enum,a.add(1,`readonly ${p}: ${t};`,!1);var u=`import { ${t} } from "./${t}";`;-1==i.content.indexOf(u)&&i.add(0,u)}else if(s[h]&&s[h].link){u=s[h].link+E.DataModel.Instance.config.export_item_suffix;if(s[h].linkIsArray){if(t!=F.TSTypeEnum.IntList&&t!=F.TSTypeEnum.StringList)return console.log(U.default.red("链接的值不是整数数组或字符串数组！-> "+o+" -> "+h)),!1;a.add(1,`readonly ${p}: ${u}[];`,!1)}else a.add(1,`readonly ${p}: ${u};`,!1);h=`import { ${u} } from "./${u}";`;-1==i.content.indexOf(h)&&i.add(0,h)}else a.add(1,`readonly ${p}: ${t};`,!1);n<r.fixed_keys.length-1&&a.newLine()}}""!=i.content&&i.newLine();l=O.StringUtils.format(t,i.content,c+e,a.content);N.IOUtils.writeTextFile(K.default.join(this._export.export_script_url,o+E.DataModel.Instance.config.export_item_suffix+"."+this._export.script_suffix),l,B.LineBreak.CRLF,`导出配置Item(${s.config_other_info.sheetType})脚本成功！-> {0}`)}else{let e=new b.CodeWriter;var i=Object.keys(r).length;let t=0;for(const x in r){var a=E.DataModel.Instance.getConfigKeyType(o,x,this._codeLang),$=O.StringUtils.convertToLowerCamelCase(x);e.add(1,`readonly ${$}: ${a};`,!1),t<i-1&&e.newLine(),t++}g=O.StringUtils.format(n,"",o,e.content);N.IOUtils.writeTextFile(K.default.join(this._export.export_script_url,o+"."+this._export.script_suffix),g,B.LineBreak.CRLF,`导出配置Item(${s.config_other_info.sheetType})脚本成功！-> {0}`)}}return!0}genMgr(){var e=q.CommonUtils.getTemplate(this._export.id,"ConfigMgr.txt");let o=new b.CodeWriter,r=new b.CodeWriter,s=new b.CodeWriter;for(let e=0;e<this._configNames.length;e++){var d=this._configNames[e],l=E.DataModel.Instance.originConfig[d],f=E.DataModel.Instance.remark[d];let i=E.DataModel.Instance.getParents(d);var g=i?i.length:0;let t=[];g&&i.forEach(e=>{t.push(E.DataModel.Instance.remark[e])});var c=f.config_other_info,_=d+E.DataModel.Instance.config.export_item_suffix,m=O.StringUtils.convertToLowerCamelCase(d);s.add(2,"// "+d),s.add(2,`section = sections[${e}];`);let a=l.fixed_keys;if(a){o.add(0,`import { ${_} } from "./${_}";`);var h,p=E.DataModel.Instance.getConfigUniqueKeyType(d,this._codeLang);E.DataModel.Instance.isConventionType(p,this._codeLang)||(h=`import { ${p} } from "./${p}";`,-1==o.content.indexOf(h)&&o.add(0,h));let t=1;c&&!c.isSingleMainKey&&(h=c.mainKeyNames,t=h.length+1),g||(r.add(1,`private static _${m}: BaseConfig<${p}, ${_}>;`),r.add(1,`public static get ${d}(): BaseConfig<${p}, ${_}> { return this._${m}; }`)),s.add(2,"totalLength = section.length;"),s.add(2,`nAdd = ${a.length+t};`);let n;g?(n=O.StringUtils.convertToLowerCamelCase(i[i.length-1],!0),s.add(2,`let map${e} = this.${n};`)):s.add(2,`let map${e} = new Map<${p}, ${_}>();`),s.add(2,"for (let n = 0; n < totalLength; n += nAdd) {"),g?(i.forEach((e,t)=>{e+=E.DataModel.Instance.config.export_item_suffix;s.add(3,`let parentItem${t+1} = this.${n}.get(section[n]) as ${e};`)}),s.add(3,`let item: ${_} = { uniqueKey: parentItem${g}.uniqueKey, `,!1)):s.add(3,`let item: ${_} = { uniqueKey: section[n], `,!1);var u=Object.keys(l.data)[0];isNaN(+u)?F.TSTypeEnum.String:F.TSTypeEnum.Int;if(c&&!c.isSingleMainKey){var $=c.mainKeyNames;for(let e=0;e<$.length;e++){var x=E.DataModel.Instance.getMainKeyVarName(e+1);g?s.add(0,x+`: parentItem${g}.${x}, `,!1):s.add(0,`${x}: section[n + ${e+1}], `,!1)}}if(g){let o=[];i.forEach((e,t)=>{var n=E.DataModel.Instance.originConfig[e].fixed_keys;for(let e=0;e<n.length;e++){var i,a=n[e];-1==o.indexOf(a)&&(i=O.StringUtils.convertToLowerCamelCase(a),s.add(0,i+`: parentItem${t+1}.${i}, `,!1),o.push(a))}})}for(let e=0;e<a.length;e++){var y=a[e];let n=!1;if(g)for(let t=i.length-1;!n&&0<=t;t--){var I=i[t];let e=E.DataModel.Instance.originConfig[I].fixed_keys;-1!=e.indexOf(y)&&(n=!0)}if(!n){var C=E.DataModel.Instance.getConfigKeyType(d,y,this._codeLang);if(f[y]&&f[y].enum){if(C!=F.TSTypeEnum.Int&&C!=F.TSTypeEnum.String)return console.log(U.default.red(`枚举的数值不是整数也不是字符串，这是不被允许的! 表名：${d}，字段：${y}，文件路径：`+f.config_other_info.filePath)),!1;s.add(0,`${O.StringUtils.convertToLowerCamelCase(y)}: section[n + ${e+t}]`,!1)}else if(f[y].link){var T=f[y].link,T=O.StringUtils.convertToLowerCamelCase(T);if(f[y].linkIsArray){if(C!=F.TSTypeEnum.IntList&&C!=F.TSTypeEnum.StringList)return console.log(U.default.red(`链接的值不是整数数组或字符串数组！表名：${d}，字段：${y}，文件路径：`+f.config_other_info.filePath)),console.log(C),!1;var C=E.DataModel.Instance.getConfigUniqueKeyType(f[y].link,this._codeLang),v=f[y].link+E.DataModel.Instance.config.export_item_suffix;s.add(0,`${O.StringUtils.convertToLowerCamelCase(y)}: this.getLinkedConfigs<${C}, ${v}>(section[n + ${e+t}], this.${f[y].link})`,!1)}else s.add(0,`${O.StringUtils.convertToLowerCamelCase(y)}: this._${T}.get(section[n + ${e+t}])`,!1)}else s.add(0,`${O.StringUtils.convertToLowerCamelCase(y)}: section[n + ${e+t}]`,!1);e==a.length-1?s.add(0," };"):s.add(0,", ",!1)}}if(g?s.add(3,`map${e}.data.set(item.uniqueKey, item);`):s.add(3,`map${e}.set(item.uniqueKey, item);`),s.add(2,"}"),g||s.add(2,`this._${m} = new BaseConfig<${p}, ${_}>("${d}", map${e});`),c&&!c.isSingleMainKey){r.newLine();var M=c.mainKeyNames,u=E.DataModel.Instance.getConfigCollectionTypeByIndex(d,this._codeLang),S="_"+m+E.DataModel.Instance.config.export_collection_suffix;r.add(1,`private static ${S}: ${u};`),r.add(1,`public static get ${d}${E.DataModel.Instance.config.export_collection_suffix}(): ${u} { return this.${S}; };`),s.newLine(),s.add(2,`this.${S} = new ${u}();`),s.add(2,`this._${m}.data.forEach(item => {`);for(let n=1;n<M.length;n++){s.add(3,"if (!this."+S,!1);let t=n;for(let e=0;e<t;e++){var D=e+1;e!=t-1?s.add(0,`.get(item.mainKey${D})`,!1):s.add(0,`.has(item.mainKey${D})`,!1)}s.add(0,")"),s.add(4,"this."+S,!1),t=n;for(let e=0;e<t;e++){var L,k=e+1;e!=t-1?s.add(0,`.get(item.mainKey${k})`,!1):(L=E.DataModel.Instance.getConfigCollectionTypeByIndex(d,this._codeLang,n,M.length-1),s.add(0,`.set(item.mainKey${k}, new ${L}());`))}}s.add(3,"this."+S,!1);for(let e=0;e<M.length;e++){var w=e+1;e!=M.length-1?s.add(0,`.get(item.mainKey${w})`,!1):s.add(0,`.set(item.mainKey${w}, item);`)}s.add(2,"});")}}else{p=`import { ${d} } from "./${d}";`;-1==o.content.indexOf(p)&&o.add(0,p),r.add(1,`private static _${m}: ${d};`),r.add(1,`public static get ${d}(): ${d} { return this._${m}; };`),a=Object.keys(l),s.add(2,`this._${m} = { configName: "${d}", `,!1),a.forEach((e,t)=>{s.addStr(O.StringUtils.convertToLowerCamelCase(e)+`: section[${t}]`),t==a.length-1?s.add(0," };"):s.addStr(", ")})}e<this._configNames.length-1&&(r.newLine(),s.newLine())}e=O.StringUtils.format(e,o.content,r.content,this._configSplitor,s.content);return N.IOUtils.writeTextFile(K.default.join(this._export.export_script_url,this._export.export_config_manager_name+"."+this._export.script_suffix),e,B.LineBreak.CRLF,`成功导出配置管理类脚本（${this._export.export_config_manager_name}）-> {0}`),!0}genConfigText(){let n=[];for(let e=0;e<this._configNames.length;e++){var i=this._configNames[e],t=E.DataModel.Instance.originConfig[i],a=t.fixed_keys;if(0<e&&n.push(this._configSplitor),a){var o=t.data;for(const l in o){var r=o[l];let e=isNaN(+l)?l:+l,t=(n.push(e),isNaN(+l)&&e.split("_"));t&&1<t.length&&E.DataModel.Instance.remark[i]&&E.DataModel.Instance.remark[i].config_other_info&&E.DataModel.Instance.remark[i].config_other_info.mainKeySubs&&t.length==E.DataModel.Instance.remark[i].config_other_info.mainKeySubs.length&&t.forEach(e=>{e=isNaN(+e)?e:+e,n.push(e)});for(let e=0;e<r.length;e++){var s=r[e];n.push(s)}}}else for(const f in t){var d=t[f];n.push(d)}}return N.IOUtils.writeTextFile(this._export.export_url,JSON.stringify(n),B.LineBreak.CRLF,"导出配置文本成功！-> {0}"),!0}}exports.GenTSModule=t;